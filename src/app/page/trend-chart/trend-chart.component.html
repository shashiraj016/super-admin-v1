<div class="dashboard-container">
    <div *ngIf="isLoading" class="loader-overlay">
        <div class="spinner"></div>
    </div>
    <!-- Header with Stats -->
    <!-- <div class="dashboard-header">
        <div class="stats-row">
            <div class="stat-item">
                <span class="stat-number">{{DistinctUsers | number}}</span>
                <span class="stat-label">Active Users</span>
            </div>
            <div class="stat-item">
                <span class="stat-number">{{ topsaLeads | number }}</span>
                <span class="stat-label">Leads</span>
            </div>
            <div class="stat-item">
                <span class="stat-number">{{ topTasks | number }}</span>
                <span class="stat-label">Tasks</span>
            </div>
            <div class="stat-item">
                <span class="stat-number">{{ topUTDs | number }}</span>
                <span class="stat-label">UTDs</span>
            </div>
            <div class="stat-item">
                <span class="stat-number">{{ topenquiryCalls | number }} / {{ topcoldCalls | number }}</span>
                <span class="stat-label">Enquiry calls / Cold calls</span>
            </div>
        </div>
    </div> -->

    <!-- Filter Controls -->
    <!-- <div class="filter-section">
        <div class="filter-row">
            <div class="dashboard-top"> -->
    <div class="filter-section">
        <div class="filter-row">
            <div class="dashboard-top" #headerSection [class.sticky]="isSticky" [class.hidden]="isHidden">
                <!-- Filters Section (Left) -->
                <div class="filter-group">
                    <!-- Dealer Filter (your full working code) -->
                    <label>Dealer Filter</label>
                    <div class="dropdown flt1" [class.show]="dropdownOpen">
                        <button class="no-border time-dropdown dropdown-toggle" type="button"
                            (click)="toggleDropdown()">
                            {{ selectedDealers.length > 0 ? 'Dealers Selected (' + selectedDealers.length + ')' :
                            'Select Dealers' }}
                        </button>
                        <div class="dropdown-menu show" *ngIf="dropdownOpen">
                            <div class="px-2 py-1">
                                <input type="text" class="form-control" placeholder="Search dealers..."
                                    [(ngModel)]="dealerSearch" (input)="filterDealers()"
                                    (click)="$event.stopPropagation()" />
                            </div>
                            <div class="d-flex justify-content-between align-items-center px-2 py-1 border-bottom">
                                <label class="mb-0 d-flex align-items-center" (click)="$event.stopPropagation()">
                                    <input type="checkbox" class="me-2" [checked]="areAllSelected()"
                                        (change)="toggleSelectAll($event); $event.stopPropagation()" /> Select All
                                </label>
                                <button type="button" class="btn btn-link btn-sm text-danger p-0 ms-auto" id="clearbtn"
                                    (click)="clearSelection(); $event.stopPropagation()">Clear</button>
                            </div>
                            <ng-container *ngIf="filteredDealers.length > 0; else noDealers">
                                <div *ngFor="let dealer of filteredDealers"
                                    class="dropdown-item d-flex align-items-center" (click)="$event.stopPropagation()">
                                    <input type="checkbox" class="me-2" [checked]="isDealerSelected(dealer)"
                                        style="border:1px solid black"
                                        (change)="toggleDealerSelection(dealer); $event.stopPropagation()" />
                                    <span (click)="toggleDealerSelection(dealer); $event.stopPropagation()">
                                        {{ dealer.dealer_name }}
                                    </span>
                                </div>
                            </ng-container>
                            <ng-template #noDealers>
                                <div class="dropdown-item text-muted text-center">No dealers found</div>
                            </ng-template>
                        </div>
                    </div>

                    <!-- Date Filter -->
                    <div class="filter-item">
                        <label>Date Filter</label>
                        <select id="usageGran" [(ngModel)]="selectedDateFilter" (change)="fetchTrendChartWithFilters()">
                            <option value="DAY">Today</option>
                            <option value="YESTERDAY">Yesterday</option>
                            <option value="WEEK">This Week</option>
                            <option value="LAST_WEEK">Last Week</option>
                            <option value="MTD">This Month</option>
                            <option value="LAST_MONTH">Last Month</option>
                            <option value="QTD">This Quarter</option>
                            <option value="LAST_QUARTER">Last Quarter</option>
                            <option value="SIX_MONTH">Last 6 Months</option>
                            <option value="YTD">Year to Date</option>
                        </select>
                    </div>
                </div>

                <!-- Stats Section (Right) -->
                <div class="stats-row">
                    <div class="stat-item">
                        <span class="stat-number">{{ DistinctUsers | number }}</span>
                        <span class="stat-label">Active Users</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">{{ topsaLeads | number }}</span>
                        <span class="stat-label">Leads</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">{{ topTasks | number }}</span>
                        <span class="stat-label">Tasks</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">{{ topUTDs | number }}</span>
                        <span class="stat-label">UTDs</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">{{ topenquiryCalls | number }} / {{ topcoldCalls | number }}</span>
                        <span class="stat-label">Enquiry / Cold calls</span>
                    </div>
                </div>
            </div>
        </div>
    </div>



    <!-- Charts Section -->
    <div class="charts-container">
        <div class="metrics-rows">
            <!-- Leads Row -->
            <div class="charts-level-header" style="display: flex;">
                <div style="flex: 1; text-align: center;" class="chart-level-title">Day Level</div>
                <div style="flex: 1; text-align: center;" class="chart-level-title">Hour Level</div>
            </div>
            <div class="metric-row">

                <div class="metric-label">
                    <h3>Leads</h3>
                </div>

                <div class="charts-pair">
                    <div class="chart-section">
                        <!-- <div class="chart-level-title">Day Level</div> -->
                        <div class="chart-wrapper">
                            <apx-chart [series]="dayLeadChart.series!" [chart]="dayLeadChart.chart!"
                                [xaxis]="dayLeadChart.xaxis!" [stroke]="dayLeadChart.stroke!"
                                [markers]="dayLeadChart.markers!" [legend]="dayLeadChart.legend!"
                                [tooltip]="dayLeadChart.tooltip!" [colors]="dayLeadChart.colors!"
                                [grid]="dayLeadChart.grid!">
                            </apx-chart>
                        </div>
                    </div>

                    <div class="chart-section">
                        <!-- <div class="chart-level-title">Hour Level</div> -->
                        <div class="chart-wrapper">
                            <apx-chart [series]="hourLeadChart.series!" [chart]="hourLeadChart.chart!"
                                [xaxis]="hourLeadChart.xaxis!" [stroke]="hourLeadChart.stroke!"
                                [markers]="hourLeadChart.markers!" [legend]="hourLeadChart.legend!"
                                [tooltip]="hourLeadChart.tooltip!" [colors]="hourLeadChart.colors!"
                                [grid]="hourLeadChart.grid!">
                            </apx-chart>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Events Row -->
            <div class="metric-row">
                <div class="metric-label">
                    <h3>Events</h3>
                </div>
                <div class="charts-pair">
                    <div class="chart-section">
                        <!-- <div class="chart-level-title">Day Level</div> -->
                        <div class="chart-wrapper">
                            <apx-chart [series]="dayEventChart.series!" [chart]="dayEventChart.chart!"
                                [xaxis]="dayEventChart.xaxis!" [stroke]="dayEventChart.stroke!"
                                [markers]="dayEventChart.markers!" [legend]="dayEventChart.legend!"
                                [tooltip]="dayEventChart.tooltip!" [colors]="dayEventChart.colors!"
                                [grid]="dayEventChart.grid!">
                            </apx-chart>
                        </div>
                    </div>

                    <div class="chart-section">
                        <!-- <div class="chart-level-title">Hour Level</div> -->
                        <div class="chart-wrapper">
                            <apx-chart [series]="hourEventChart.series!" [chart]="hourEventChart.chart!"
                                [xaxis]="hourEventChart.xaxis!" [stroke]="hourEventChart.stroke!"
                                [markers]="hourEventChart.markers!" [legend]="hourEventChart.legend!"
                                [tooltip]="hourEventChart.tooltip!" [colors]="hourEventChart.colors!"
                                [grid]="hourEventChart.grid!">
                            </apx-chart>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tasks Row -->
            <div class="metric-row">
                <div class="metric-label">
                    <h3>Tasks</h3>
                </div>
                <div class="charts-pair">
                    <div class="chart-section">
                        <!-- <div class="chart-level-title">Day Level</div> -->
                        <div class="chart-wrapper">
                            <apx-chart [series]="dayTaskChart.series!" [chart]="dayTaskChart.chart!"
                                [xaxis]="dayTaskChart.xaxis!" [stroke]="dayTaskChart.stroke!"
                                [markers]="dayTaskChart.markers!" [legend]="dayTaskChart.legend!"
                                [tooltip]="dayTaskChart.tooltip!" [colors]="dayTaskChart.colors!"
                                [grid]="dayTaskChart.grid!">
                            </apx-chart>
                        </div>
                    </div>

                    <div class="chart-section">
                        <!-- <div class="chart-level-title">Hour Level</div> -->
                        <div class="chart-wrapper">
                            <apx-chart [series]="hourTaskChart.series!" [chart]="hourTaskChart.chart!"
                                [xaxis]="hourTaskChart.xaxis!" [stroke]="hourTaskChart.stroke!"
                                [markers]="hourTaskChart.markers!" [legend]="hourTaskChart.legend!"
                                [tooltip]="hourTaskChart.tooltip!" [colors]="hourTaskChart.colors!"
                                [grid]="hourTaskChart.grid!">
                            </apx-chart>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <!-- PS-wise Activity Section -->
        <div class="ps-wise-activity" *ngIf="psWiseCharts.length > 0">
            <div class="ps-section-header">
                <div class="chart-title">PS-wise Activity</div>
                <!-- Role Filter Dropdown -->
                <select [(ngModel)]="roleFilter" (change)="scheduleProcessPsActivity()" class="role-filter-select">
                    <option value="PS">PS</option>
                    <option value="SM">SM</option>
                    <option value="Both">Both</option>
                </select>
            </div>

            <!-- Scrollable Dealers Container -->
            <div class="dealers-scroll-container">
                <!-- Dealers Loop -->
                <div class="dealer-block" *ngFor="let dealerGroup of psWiseCharts">
                    <!-- Dealer Header -->
                    <div class="dealer-header">
                        <h3>{{ dealerGroup.dealerName }}</h3>
                        <div class="user-count-badge">{{ dealerGroup.users.length }} Users</div>
                    </div>

                    <!-- Horizontal Charts Container -->
                    <div class="horizontal-charts-container">
                        <div class="chart-column" *ngFor="let chart of dealerGroup.charts; let isLast = last">
                            <!-- Chart Header -->
                            <div class="chart-header-section">
                                <div class="chart-title-row">
                                    <span class="metric-title">{{ chart.title }}</span>
                                    <!-- Call Type Dropdown -->
                                    <ng-container *ngIf="chart.title.toLowerCase().includes('calls')">
                                        <div class="call-type-selector">
                                            <select [(ngModel)]="psWiseSelectedCallType"
                                                (change)="psWiseOnCallTypeChange()" class="ps-calls-select">
                                                <option *ngFor="let type of psWiseCallTypes" [value]="type.value">
                                                    {{ type.label }}
                                                </option>
                                            </select>
                                        </div>
                                    </ng-container>
                                </div>

                                <!-- Averages Row -->
                                <div class="averages-row">
                                    <div class="avg-item">
                                        <span class="avg-label">Avg:</span>
                                        <span class="avg-value dealer-avg">{{ chart.dealerAvg }}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Custom Bar Chart Container -->
                            <div class="custom-chart-wrapper">
                                <div class="custom-chart-container">
                                    <!-- User Bars -->
                                    <div class="user-bar" *ngFor="let user of chart.users; let i = index">
                                        <!-- User Info -->
                                        <div class="user-info">
                                            <span class="user-name" [title]="user.name">{{ user.name }}</span>
                                        </div>

                                        <!-- Bar Container -->
                                        <div class="bar-container">
                                            <div class="bar-background">
                                                <div class="bar-fill"
                                                    [style.background-color]="getBarColor(i, chart.title)"
                                                    [style.width.%]="shouldFillBars ? getBarWidth(user.value, chart.maxValue) : 0">
                                                </div>

                                            </div>
                                            <!-- Value span outside bar-background -->
                                            <span class="user-value">{{ user.value }}</span>
                                        </div>

                                    </div>

                                    <!-- Empty state -->
                                    <div class="empty-state" *ngIf="chart.users.length === 0">
                                        <span>No data available</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Vertical Divider -->
                            <div class="chart-divider" *ngIf="!isLast"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>





    </div>
</div>
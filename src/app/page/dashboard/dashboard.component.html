

<ng-container *ngIf="!selectedDealer && !selectedSM">
  <div class="header2" [ngClass]="{ 'sidebar-open': isSidebarOpen, 'sidebar-closed': !isSidebarOpen }"
    style="border-radius:7px;padding:10px;margin-top:1rem;">
    <div style=" display: inline-flex;">
      <div class="dropdown" [class.show]="dropdownOpen" style="margin-right: 5px;">
        <button class="time-dropdown dropdown-toggle" type="button" (click)="toggleDropdown()">
          {{ selectedDealers.length > 0 ? 'Dealers Selected (' + selectedDealers.length + ')' : 'Select Dealers' }}
        </button>
        <div class="dropdown-menu show" *ngIf="dropdownOpen">
          <div class="px-2 py-1">
            <input type="text" class="form-control" placeholder="Search dealers..." [(ngModel)]="dealerSearch"
              (input)="filterDealers()" (click)="$event.stopPropagation()" />
          </div>

          <div class="d-flex justify-content-between align-items-center px-2 py-1 border-bottom">
            <label class="mb-0 d-flex align-items-center" (click)="$event.stopPropagation()">
              <input type="checkbox" class="me-2" [checked]="areAllSelected()"
                (change)="toggleSelectAll($event); $event.stopPropagation()" />
              Select All
            </label>
            <button type="button" class="btn btn-link btn-sm text-danger p-0 ms-auto" style="margin-left:160px;"
              (click)="clearSelection(); $event.stopPropagation()">
              Clear
            </button>
          </div>
          <ng-container *ngIf="filteredDealers.length > 0; else noDealers">
            <button *ngFor="let dealer of filteredDealers" class="dropdown-item d-flex align-items-center"
              (click)="$event.stopPropagation()">
              <input type="checkbox" class="me-2" [checked]="isDealerSelected(dealer)"
                (change)="toggleDealerSelection(dealer)" style="border:1px solid black" />
              {{ dealer.dealerName }}
            </button>
          </ng-container>

          <ng-template #noDealers>
            <div class="dropdown-item text-muted text-center">
              No dealers found
            </div>
          </ng-template>
        </div>
      </div>
      <select [(ngModel)]="selectedFilter" (change)="onFilterChange(selectedFilter)" class="time-dropdown"
        style="margin-right: 5px;">
        <option value="Today">Today</option>
        <option value="Yesterday">Yesterday</option>
        <option value="This Week">This Week</option>
        <option value="Last Week">Last Week</option>
        <option value="This Month">This Month</option>
        <option value="Last Month">Last Month</option>
        <option value="This Quarter">This Quarter</option>
        <option value="Last Quarter">Last Quarter</option>
        <option value="Last 6 Months">Last 6 Months</option>
        <option value="This Year">This Year</option>
        <option value="Lifetime">Lifetime</option>
        <option value="CUSTOM">Custom</option>
      </select>
      <div *ngIf="selectedFilter === 'CUSTOM'" class="custom-inputs">
        <input type="date" [(ngModel)]="customStartDate" placeholder="Start Date" class="custom-date" />
        <input type="date" [(ngModel)]="customEndDate" placeholder="End Date" class="custom-date" />
        <button (click)="applyCustomDate()" class="apply-btn">Apply</button>
        <button (click)="resetCustomDate()" class="reset-btn">Reset</button>
      </div>
    </div>
  </div>

  <div class="content-section active" style="margin-bottom: 2rem;">
    <main class="main-content">
      <section class="kpi-section">
        <div class="kpi-card">
          <div class="kpi-label">Dealers</div>
          <div class="kpi-value" style="color:black;">{{ kpiData.dealers }}</div>
          <div class="kpi-secondary">Network: <span class="kpi-highlight">{{ kpiData.activeNetwork }}</span></div>

        </div>
        <div class="kpi-card">
          <div class="kpi-label">Users</div>
          <div class="kpi-value" style="color:black;">{{ kpiData.users }}</div>
          <div class="kpi-secondary">Active: <span class="kpi-highlight">{{ kpiData.activeUsers }}</span></div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">Leads</div>
          <div class="kpi-value" style="color:black;">{{ kpiData.leads }}</div>
          <div class="kpi-secondary">Across all dealers</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">Calls</div>
          <div class="kpi-value" style="color:black;">{{ kpiData.calls }}</div>
          <div class="kpi-secondary">Total volume</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">Total Followups</div>
          <div class="kpi-value" style="color:black;">{{ kpiData.calls }}</div>
          <!-- <div class="kpi-secondary">Total volume</div> -->
        </div>
        <div class="kpi-card">
          <div class="kpi-label">Unique/Completed Test Drives</div>
          <div class="kpi-value" style="color:black;">
            {{ kpiData.unique || 0 }}/{{ kpiData.completed || 0 }}
          </div>
          <!-- <div class="kpi-secondary">Total volume</div> -->
        </div>
      </section>

      <div class="table-section">
        <div class="table-header">
          <div>
            <h2 class="table-title">Dealer Summary — Engagement</h2>
            <p class="table-subtitle">Users, Leads, Follow-ups, Test Drives (with CXP/ICS sync)</p>
          </div>

          <div class="table-actions flex items-center gap-2">


            <!-- Export CSV button -->
            <button type="button" class="btn btn-small btn-secondary" (click)="exportToCSV()">
              <i class="icon-download"></i> Export CSV
            </button>
          </div>
        </div>

        <div class="table-container">
          <div class="table-scroll">
            <table class="data-table">
              <thead class="table-thead">
                <tr>
                  <th class="sticky-col-header th-left">Dealer</th>
                  <!-- <th class="th-right">Total Users</th> -->
                  <th class="th-right" style="cursor: pointer;" (click)="sortData('totalUsers')">
                    Total Users
                    <span *ngIf="sortColumn === 'totalUsers' && sortDirection !== 'default'">
                      {{ sortDirection === 'asc' ? '▲' : '▼' }}
                    </span>
                  </th>
                  <!-- <th class="th-right">Active Users</th> -->
                  <th class="th-right" style="cursor: pointer;" (click)="sortData('activeUsers')">
                    Active Users
                    <span *ngIf="sortColumn === 'activeUsers' && sortDirection !== 'default'">
                      {{ sortDirection === 'asc' ? '▲' : '▼' }}
                    </span>
                  </th>

                  <!-- <th class="th-right">Leads (Total)</th> -->

                  <th class="th-right" style="cursor: pointer;" (click)="sortData('saLeads')">
                    SA Leads
                    <span *ngIf="sortColumn === 'saLeads' && sortDirection !== 'default'">
                      {{ sortDirection === 'asc' ? '▲' : '▼' }}
                    </span>
                  </th>


                  <!-- <th class="th-right">Leads (sync to CXP)</th> -->
                  <th class="th-right" style="cursor: pointer;" (click)="sortData('cxpLeads')">
                    Sync with CXP
                    <span *ngIf="sortColumn === 'cxpLeads' && sortDirection !== 'default'">
                      {{ sortDirection === 'asc' ? '▲' : '▼' }}
                    </span>
                  </th>


                  <!-- <th class="th-right">Leads (sync to ICS)</th> -->
                  <th class="th-right" style="cursor: pointer;" (click)="sortData('icsLeads')">
                    Sync with ICS
                    <span *ngIf="sortColumn === 'icsLeads' && sortDirection !== 'default'">
                      {{ sortDirection === 'asc' ? '▲' : '▼' }}
                    </span>
                  </th>

                    <th class="th-right" style="cursor: pointer;" (click)="sortData('manuallyEnteredLeads')">
                    Manually Entered with CXP
                      <span *ngIf="sortColumn === 'manuallyEnteredLeads' && sortDirection !== 'default'">
                        {{ sortDirection === 'asc' ? '▲' : '▼' }}
                      </span>
                    </th>


                  <!-- <th class="th-right">Follow-ups (Total)</th> -->
                  <th class="th-right" style="cursor: pointer;" (click)="sortData('totalFollowUps')">
                    SA Followups
                    <span *ngIf="sortColumn === 'totalFollowUps' && sortDirection !== 'default'">
                      {{ sortDirection === 'asc' ? '▲' : '▼' }}
                    </span>
                  </th>

                      <th class="th-right" style="cursor: pointer;" (click)="sortData('cxpFollowUps')">
                        Sync with CXP
                        <span *ngIf="sortColumn === 'cxpFollowUps' && sortDirection !== 'default'">
                          {{ sortDirection === 'asc' ? '▲' : '▼' }}
                        </span>
                      </th>

                  <th class="th-right" style="cursor: pointer;" (click)="sortData('openFollowUps')">
                   Completed Followups
                    <span *ngIf="sortColumn === 'openFollowUps' && sortDirection !== 'default'">
                      {{ sortDirection === 'asc' ? '▲' : '▼' }}
                    </span>
                  </th>


                  <!-- <th class="th-right">Follow-ups Closed</th> -->
                  <th class="th-right" style="cursor: pointer;" (click)="sortData('openFollowUps')">
                    Upcoming followups
                    <span *ngIf="sortColumn === 'openFollowUps' && sortDirection !== 'default'">
                      {{ sortDirection === 'asc' ? '▲' : '▼' }}
                    </span>
                  </th>

                  <th class="th-right" style="cursor: pointer;" (click)="sortData('closedFollowUps')">
                    Overdue followups
                    <span *ngIf="sortColumn === 'closedFollowUps' && sortDirection !== 'default'">
                      {{ sortDirection === 'asc' ? '▲' : '▼' }}
                    </span>
                  </th>

                  <!-- <th class="th-right">Follow-ups (sync to CXP)</th> -->
              
                  <!-- <th class="th-right">Test Drives (Total)</th> -->
                  <th class="th-right" style="cursor: pointer;" (click)="sortData('totalTestDrives')">
                     SA Test Drives
                    <span *ngIf="sortColumn === 'totalTestDrives' && sortDirection !== 'default'">
                      {{ sortDirection === 'asc' ? '▲' : '▼' }}
                    </span>
                  </th>

                  <th class="th-right" style="cursor: pointer;" (click)="sortData('cxpTestDrives')">
                    sync to CXP
                    <span *ngIf="sortColumn === 'cxpTestDrives' && sortDirection !== 'default'">
                      {{ sortDirection === 'asc' ? '▲' : '▼' }}
                    </span>
                  </th>
                  <th class="th-right" style="cursor: pointer;" (click)="sortData('completedTestDrives')">
                    Completed test drives 
                    <span *ngIf="sortColumn === 'completedTestDrives' && sortDirection !== 'default'">
                      {{ sortDirection === 'asc' ? '▲' : '▼' }}
                    </span>
                  </th>

                  <th class="th-right" style="cursor: pointer;" (click)="sortData('uniqueTestDrives')">
                   Upcoming 
                    <span *ngIf="sortColumn === 'uniqueTestDrives' && sortDirection !== 'default'">
                      {{ sortDirection === 'asc' ? '▲' : '▼' }}
                    </span>
                  </th>
                  <th class="th-right" style="cursor: pointer;" (click)="sortData('closedTestDrives')">
                    Overdue
                    <span *ngIf="sortColumn === 'closedTestDrives' && sortDirection !== 'default'">
                      {{ sortDirection === 'asc' ? '▲' : '▼' }}
                    </span>
                  </th>
                  <th class="th-right" style="cursor: pointer;" (click)="sortData('opportunitiesConverted')">
                    Opportunities Converted
                    <span *ngIf="sortColumn === 'opportunitiesConverted' && sortDirection !== 'default'">
                      {{ sortDirection === 'asc' ? '▲' : '▼' }}
                    </span>
                  </th>
                 
                </tr>
              </thead>

              <tbody>
                <ng-container
                  *ngFor="let dealer of (selectedDealers.length > 0 ? selectedDealers : dealers) | slice:0:table1Length; let i = index">
                  <tr *ngIf="dealer" class="table-row">
                    <td class="sticky-col td-font-medium">
                      <button class="expand-btn" (click)="toggleRow($event, dealer, 'engagement-' + i)">
                        <span class="arrow">{{ expandedRow === 'engagement-' + i ? 'v' : '>' }}</span>
                        {{ dealer.dealerName }}
                      </button>
                    </td>
                    <td class="td-right">{{ dealer.totalUsers ?? 0 }}</td>
                    <td class="td-right">{{ dealer.activeUsers ?? 0 }}</td>

                    <td class="td-right" style="color:#222fb9">{{ dealer.saLeads ?? 0 }}</td>
                    <td class="td-right" [ngStyle]="{'color': dealer.saLeads === dealer.cxpLeads ? 'green' : 'red'}">
                      {{ dealer.cxpLeads ?? 0 }}
                    </td>
                    <td class="td-right">{{ dealer.icsLeads ?? 0 }}</td>
                    <td class="td-right">{{ dealer.manuallyEnteredLeads ?? 0 }}</td>



                    <td class="td-right" style="color:#222fb9">{{ dealer.totalFollowUps ?? 0 }}</td> 
                    <!-- SA FOLLOWUPS -->
                    <td class="td-right" [ngStyle]="{'color': dealer.totalFollowUps === dealer.cxpFollowUps ? 'green' : 'red'}">
                      {{ dealer.cxpFollowUps ?? 0 }}
                    </td>
                    
                    <td class="td-right">{{ dealer.openFollowUps ?? 0 }}</td>
                    <!-- Compeplteted followups -->

                    <td class="td-right">{{ dealer.openFollowUps ?? 0 }}</td>
                    <td class="td-right">{{ dealer.closedFollowUps ?? 0 }}</td>
                    <!-- <td class="td-right">{{ dealer.cxpFollowUps ?? 0 }}</td> -->
                    
                    <td class="td-right" style="color:#222fb9">{{ dealer.totalTestDrives ?? 0 }}</td>
                      <td class="td-right" [ngStyle]="{'color': dealer.totalTestDrives === dealer.cxpTestDrives ? 'green' : 'red'}">
                        {{ dealer.cxpTestDrives ?? 0 }}
                      </td>
                                          <td class="td-right">{{ dealer.completedTestDrives ?? 0 }}</td>
                                          <td class="td-right">{{ dealer.upcomingTestDrives ?? 0 }}</td>
                    <!-- upcomingtestfrives -->
                    <td class="td-right">{{ dealer.closedTestDrives ?? 0 }}</td>
                    <!-- <td class="td-right">{{ dealer.uniqueTestDrives ?? 0 }}</td> -->
                    <!-- <td class="td-right">{{ dealer.cxpTestDrives ?? 0 }}</td> -->
                  
                    <td class="td-right">{{ dealer.opportunitiesConverted ?? 0 }}</td>

                  </tr>

                  <!-- Sub Row -->
                  <tr *ngIf="expandedRow === 'engagement-' + i" class="sub-row">
                    <td colspan="15" class="sub-row-content">
                      <div class="sub-row-inner">
                        <div class="sub-row-title" style="text-align: left;">
                          User-wise details — {{ dealer.dealerName }}
                        </div>
                        <div class="sub-table-container">
                          <div class="sub-table-scroll">

                            <table class="sub-table">
                              <thead class="sub-table-thead">
                                <tr>
                                  <th style="text-align:left">User</th>
                                  <th>Active</th>
                                  <th>Leads (Total)</th>
                                  <th>Leads (CXP)</th>
                                  <th>Leads (ICS)</th>
                                  <th>Follow-ups (Total)</th>
                                  <th>Open</th>
                                  <th>Closed</th>
                                  <th>Follow-ups (CXP)</th>
                                  <th>Test Drives (Total)</th>
                                  <th>Unique Test Drives</th>
                                  <th>Completed Test Drives</th>
                                  <th>Closed</th>
                                  <th>Test Drives (CXP)</th>
                                </tr>
                              </thead>
                              <tbody>
                                <!-- <tr *ngFor="let user of dealerUsers[dealer.dealerId] ?? []">
                                <td style="text-align:left">{{ user.user }}</td>
                                <td class="td-center">
                                  <span class="chip" [ngClass]="user.active ? 'chip-success' : 'chip-inactive'">
                                    {{ user.active ? 'Active' : 'Inactive' }}
                                  </span>
                                </td> -->
                                <tr *ngFor="let user of getSortedUsers(dealer.dealerId)">
                                  <!-- <td style="text-align:left">{{ user.user }}</td> -->
                                  <td style="text-align:left">
                                    {{ user.user }} <span *ngIf="user.user_role">({{ user.user_role }})</span>
                                  </td>
                                  <td class="td-center">
                                    <span class="chip" [ngClass]="user.active ? 'chip-success' : 'chip-inactive'">
                                      {{ user.active ? 'Active' : 'Inactive' }}
                                    </span>
                                  </td>
                                  <td class="td-right">{{ user.leads?.total ?? 0 }}</td>
                                  <td class="td-right">{{ user.leads?.cxp ?? 0 }}</td>
                                  <td class="td-right">{{ user.leads?.ics ?? 0 }}</td>
                                  <td class="td-right">{{ user.followups?.total ?? 0 }}</td>
                                  <td class="td-right">{{ user.followups?.open ?? 0 }}</td>
                                  <td class="td-right">{{ user.followups?.closed ?? 0 }}</td>
                                  <td class="td-right">{{ user.followups?.cxp ?? 0 }}</td>
                                  <td class="td-right">{{ user.testdrives?.total ?? 0 }}</td>
                                  <td class="td-right">{{ user.testdrives?.unique ?? 0 }}</td>
                                  <td class="td-right">{{ user.testdrives?.completed ?? 0 }}</td>
                                  <td class="td-right">{{ user.testdrives?.closed ?? 0 }}</td>
                                  <td class="td-right">{{ user.testdrives?.cxp ?? 0 }}</td>
                                </tr>
                                <tr *ngIf="!dealerUsers[dealer.dealerId] || dealerUsers[dealer.dealerId]?.length === 0">
                                  <td colspan="14" class="td-center">No Users Found</td>
                                </tr>
                              </tbody>
                            </table>
                          </div>
                        </div>
                      </div>
                    </td>
                  </tr>
                </ng-container>
              </tbody>
            </table>
            <!-- Show More button -->
            <button type="button" style="margin: 0.5rem; float: right;" class="btn btn-primary"
              (click)="showMoreTable1()"
              *ngIf="table1Length < (selectedDealers.length > 0 ? selectedDealers.length : dealers.length)">
              Show More
            </button>

            <!-- Show Less button -->
            <button type="button" style="margin: 0.5rem; float: right;" class="btn btn-secondary"
              (click)="showLessTable1()"
              *ngIf="table1Length > 5 && (selectedDealers.length > 0 ? selectedDealers.length : dealers.length) > 5">
              Show Less
            </button>

          </div>
        </div>





      </div>

      <!-- Table 2 -->
      <div class="table-section">
        <div class="table-header">
          <div>
            <h2 class="table-title">Dealer Summary — Calls</h2>
            <p class="table-subtitle">Call volumes and outcomes</p>
          </div>
          <div class="table-actions">
            <div class="nav-button-group" style="margin-left:10px;">

              <button class="nav-button" [ngClass]="{ 'active': dealerSummaryCallsViewType === 'table' }"
                (click)="dealerEngagementView('table')">
                <i class="fas fa-table" style="margin-right: 6px; font-size:15px;"></i> Table
              </button>

              <button class="nav-button" [ngClass]="{ 'active': dealerSummaryCallsViewType === 'chart' }"
                (click)="dealerEngagementView('chart')">
                <i class="fas fa-chart-line" style="margin-right: 8px;"></i> Line Chart
              </button>

              <!-- <button class="nav-button" [ngClass]="{ 'active': dealerSummaryCallsViewType === 'enquiry' }"
                  (click)="dealerEngagementView('enquiry')">
                  <i class="fas fa-envelope" style="margin-right: 6px;"></i> Enquiry
                </button>
                
                <button class="nav-button" [ngClass]="{ 'active': dealerSummaryCallsViewType === 'cold' }"
                  (click)="dealerEngagementView('cold')">
                  <i class="fas fa-phone-alt" style="margin-right: 6px;"></i> Cold Calls
                </button> -->

            </div>
            <!-- <button class="btn btn-small btn-secondary">
            <i class="icon-download"></i> Export CSV
          </button> -->
            <button class="btn btn-small btn-secondary" (click)="exportUserCallLogsToCSV()">
              <i class="icon-download"></i> Export CSV
            </button>

          </div>
        </div>
        <!-- Table View -->
        <div *ngIf="dealerSummaryCallsViewType === 'table'" class="table-container">
          <div class="table-scroll">
            <table class="data-table calls-table">
              <thead class="table-thead">
                <tr>
                  <th class="sticky-col-header th-left" style="width:18%">Dealer</th>
                  <th class="th-right">Total Calls</th>
                  <th class="th-right">Outgoing</th>
                  <th class="th-right">Incoming</th>
                  <th class="th-right">Connected</th>
                  <th class="th-right">Declined</th>
                  <th class="th-right th-rounded-right">Duration</th>
                </tr>
              </thead>
              <tbody>
                <ng-container *ngFor="let dealer of dealers | slice:0:table2Length; let i = index">
                  <!-- Main dealer row -->
                  <tr>
                    <td class="sticky-col td-font-medium">
                      <button class="expand-btn" (click)="toggleRow($event, dealer, 'engagement-' + i)">
                        <span class="arrow">{{ expandedRow === 'engagement-' + i ? 'v' : '>' }}</span>
                        {{ dealer.dealerName }}
                      </button>
                    </td>
                    <td>{{ dealer.callLogs?.totalCalls || 0 }}</td>
                    <td>{{ dealer.callLogs?.outgoing || 0 }}</td>
                    <td>{{ dealer.callLogs?.incoming || 0 }}</td>
                    <td>{{ dealer.callLogs?.connected || 0 }}</td>
                    <td>{{ dealer.callLogs?.declined || 0 }}</td>
                    <td>{{ dealer.callLogs?.duration || '00:00:00' }}</td>
                  </tr>

                  <!-- Sub-row: user call logs -->
                  <tr *ngIf="expandedRow === 'engagement-' + i">
                    <td colspan="7">
                      <div class="sub-table-container">
                        <div class="sub-user-table-scroll">
                          <table class="sub-table calls-sub-table">
                            <thead>
                              <tr>
                                <th style="text-align:left;width:15%">User</th>
                                <th>Total</th>
                                <th>Outgoing</th>
                                <th>Incoming</th>
                                <th>Connected</th>
                                <th>Declined</th>
                                <th>Duration</th>
                              </tr>
                            </thead>
                            <tbody>
                              <tr *ngFor="let userCall of userCallLogs[dealer.dealerId]">
                                <td style="text-align:left">{{ userCall.name }}</td>
                                <td>{{ userCall.calls.total }}</td>
                                <td>{{ userCall.calls.outgoing }}</td>
                                <td>{{ userCall.calls.incoming }}</td>
                                <td>{{ userCall.calls.connected }}</td>
                                <td>{{ userCall.calls.declined }}</td>
                                <td>{{ userCall.calls.duration }}</td>
                              </tr>
                              <tr *ngIf="!userCallLogs[dealer.dealerId] || userCallLogs[dealer.dealerId]?.length === 0">
                                <td colspan="7" style="text-align: center; font-style: italic;">
                                  No call logs found
                                </td>
                              </tr>
                            </tbody>
                          </table>
                        </div>
                      </div>
                    </td>
                  </tr>
                </ng-container>
              </tbody>
            </table>

            <!-- Show More / Show Less buttons -->
            <div style="display:flex; justify-content:flex-end; gap:0.5rem; margin-top:0.5rem;">
              <button type="button" class="btn btn-primary" (click)="showMoreTable2()"
                *ngIf="table2Length < dealers.length">
                Show More
              </button>
              <button type="button" class="btn btn-secondary" (click)="showLessTable2()"
                *ngIf="table2Length > 5 && dealers.length > 5">
                Show Less
              </button>
            </div>
          </div>
        </div>

        <!-- Chart View -->
        <div *ngIf="dealerSummaryCallsViewType === 'chart'" class="chart-container"
          style="min-height:400px; padding:20px; background:white; border-radius:10px;">
          <h1>chart here</h1>
        </div>

      </div>


    </main>
  </div>
</ng-container>
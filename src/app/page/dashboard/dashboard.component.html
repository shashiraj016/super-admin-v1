<ng-container *ngIf="!selectedDealer && !selectedSM">
  <div *ngIf="isLoading" class="loader-overlay">
    <div class="spinner"></div>
  </div>
  <div class="header2" [ngClass]="{ 'sidebar-open': isSidebarOpen, 'sidebar-closed': !isSidebarOpen }"
    style="border-radius:7px;padding:10px;margin-top:1rem;">
    <div class="fltt">

      <select [(ngModel)]="selectedFilter" (change)="onFilterChange(selectedFilter)" class="time-dropdown flt1"
        style="margin-right: 5px;">
        <option value="DAY">Day</option>
        <option value="YESTERDAY">Yesterday</option>
        <option value="WEEK">This Week</option>
        <option value="LAST_WEEK">Last Week</option>
        <option value="MTD">This Month</option>
        <option value="LAST_MONTH">Last Month</option>
        <option value="QTD">This Quarter</option>
        <option value="LAST_QUARTER">Last Quarter</option>
        <option value="SIX_MONTH">Last 6 Months</option>
        <option value="YTD">This Year</option>
        <option value="LIFETIME">Lifetime</option>
        <option value="CUSTOM">Custom</option>
      </select>
      <div *ngIf="selectedFilter === 'CUSTOM'" class="custom-inputs flt1">
        <input type="date" [(ngModel)]="customStartDate" placeholder="Start Date" class="custom-date" />
        <input type="date" [(ngModel)]="customEndDate" placeholder="End Date" class="custom-date" />
        <button (click)="applyCustomDate()" class="apply-btn flt2">Apply</button>
        <button (click)="resetCustomDate()" class="reset-btn flt2">Reset</button>
      </div>
      <div class="dropdown flt1" [class.show]="dropdownOpen" style="margin-right: 5px;">
        <button class="time-dropdown dropdown-toggle" type="button" (click)="toggleDropdown()">
          {{ selectedDealers.length > 0 ? 'Dealers Selected (' + selectedDealers.length + ')' : 'Select Dealers' }}
        </button>
        <div class="dropdown-menu show" *ngIf="dropdownOpen">
          <div class="px-2 py-1">
            <input type="text" class="form-control" placeholder="Search dealers..." [(ngModel)]="dealerSearch"
              (input)="filterDealers()" (click)="$event.stopPropagation()" />
          </div>

          <div class="d-flex justify-content-between align-items-center px-2 py-1 border-bottom">
            <label class="mb-0 d-flex align-items-center" (click)="$event.stopPropagation()">
              <input type="checkbox" class="me-2" [checked]="areAllSelected()"
                (change)="toggleSelectAll($event); $event.stopPropagation()" />
              Select All
            </label>
            <button type="button" class="btn btn-link btn-sm text-danger p-0 ms-auto" style="margin-left:120px;"
              (click)="clearSelection(); $event.stopPropagation()">
              Clear
            </button>
          </div>
          <ng-container *ngIf="filteredDealers.length > 0; else noDealers">
            <button *ngFor="let dealer of filteredDealers" class="dropdown-item d-flex align-items-center"
              (click)="$event.stopPropagation()">
              <input type="checkbox" class="me-2" [checked]="isDealerSelected(dealer)"
                (change)="toggleDealerSelection(dealer)" style="border:1px solid black" />
              {{ dealer.dealerName }}
            </button>
          </ng-container>

          <ng-template #noDealers>
            <div class="dropdown-item text-muted text-center">
              No dealers found
            </div>
          </ng-template>
        </div>
      </div>
    </div>
  </div>

  <div class="content-section active" style="margin-bottom: 2rem;">
    <main class="main-content">
      <section class="kpi-section">

        <div class="kpi-card">
          <div class="kpi-label">Active Network:</div>
          <div class="kpi-value" style="color:black;">{{ kpiData?.activeNetwork }}</div>
          <div class="kpi-secondary">Dealers: <span class="kpi-highlight">{{ kpiData?.dealers }}</span></div>
        </div>

        <!-- <div class="kpi-card">
          <div class="kpi-label">Users</div>
          <div class="kpi-value" style="color:black;">{{ kpiData?.users }}</div>
          <div class="kpi-secondary">Active: <span class="kpi-highlight">{{ kpiData?.activeUsers }}</span></div>
        </div> -->
        <div class="kpi-card">
          <div class="kpi-label">Active</div>
          <div class="kpi-value" style="color:black;">{{ kpiData?.activeUsers }}</div>
          <div class="kpi-secondary">Users: <span class="kpi-highlight">{{ kpiData?.users }}</span></div>
        </div>

        <div class="kpi-card">
          <div class="kpi-label">Leads</div>
          <div class="kpi-value" style="color:black;">{{ kpiData?.leads }}</div>
          <div class="kpi-secondary">Across all dealers</div>
        </div>

        <div class="kpi-card">
          <div class="kpi-label">Calls</div>
          <div class="kpi-value" style="color:black;">{{ kpiData?.calls }}</div>
          <div class="kpi-secondary">Total volume</div>
        </div>

        <div class="kpi-card">
          <div class="kpi-label">Total Followups</div>
          <div class="kpi-value" style="color:black;">{{ kpiData?.totalFollowUps }}</div>
        </div>

        <div class="kpi-card">
          <div class="kpi-label">Unique / Completed Test Drives</div>
          <div class="kpi-value" style="color:black;">
            {{ kpiData?.uniqueTestDrives }} / {{ kpiData?.completedTestDrives }}
          </div>
        </div>

      </section>

      <div class="table-section">
        <div class="table-header">
          <div>
            <h2 class="table-title">Dealer Summary — Engagement</h2>
            <p class="table-subtitle">Users, Leads, Follow-ups, Test Drives (with CXP/ICS sync)</p>
          </div>

          <div class="table-actions flex items-center gap-2">


            <!-- Export CSV button -->
            <button type="button" class="btn btn-small btn-secondary" (click)="exportToCSV()">
              <i class="icon-download"></i> Export CSV
            </button>
          </div>
        </div>

        <div class="table-container">
          <div class="table-scroll">
            <table class="data-table">
              <!-- <thead class="table-thead">
                <tr>
                  <th class="sticky-col-header th-left">Dealer</th>
                  <th class="th-right " style="cursor: pointer;" (click)="sortData('totalUsers')">
                    Total Users
                    <span *ngIf="sortColumn === 'totalUsers' && sortDirection !== 'default'">
                      {{ sortDirection === 'asc' ? '▲' : '▼' }}
                    </span>
                  </th>
                  <th class="th-right" style="cursor: pointer;" (click)="sortData('activeUsers')">
                    Active Users
                    <span *ngIf="sortColumn === 'activeUsers' && sortDirection !== 'default'">
                      {{ sortDirection === 'asc' ? '▲' : '▼' }}
                    </span>
                  </th>


                  <th class="th-right" style="cursor: pointer;" (click)="sortData('saLeads')">
                    SA Leads
                    <span *ngIf="sortColumn === 'saLeads' && sortDirection !== 'default'">
                      {{ sortDirection === 'asc' ? '▲' : '▼' }}
                    </span>
                  </th>


                  <th class="th-right" style="cursor: pointer;" (click)="sortData('cxpLeads')">
                    Sync with CXP
                    <span *ngIf="sortColumn === 'cxpLeads' && sortDirection !== 'default'">
                      {{ sortDirection === 'asc' ? '▲' : '▼' }}
                    </span>
                  </th>


                  <th class="th-right" style="cursor: pointer;" (click)="sortData('icsLeads')">
                    Sync with ICS
                    <span *ngIf="sortColumn === 'icsLeads' && sortDirection !== 'default'">
                      {{ sortDirection === 'asc' ? '▲' : '▼' }}
                    </span>
                  </th>

                  <th class="th-right" style="cursor: pointer;" (click)="sortData('manuallyEnteredLeads')">
                    Manually Entered with CXP
                    <span *ngIf="sortColumn === 'manuallyEnteredLeads' && sortDirection !== 'default'">
                      {{ sortDirection === 'asc' ? '▲' : '▼' }}
                    </span>
                  </th>


                  <th class="th-right" style="cursor: pointer;" (click)="sortData('saFollowUps')">
                    SA Followups
                    <span *ngIf="sortColumn === 'saFollowUps' && sortDirection !== 'default'">
                      {{ sortDirection === 'asc' ? '▲' : '▼' }}
                    </span>
                  </th>

                  <th class="th-right" style="cursor: pointer;" (click)="sortData('cxpFollowUps')">
                    Sync with CXP
                    <span *ngIf="sortColumn === 'cxpFollowUps' && sortDirection !== 'default'">
                      {{ sortDirection === 'asc' ? '▲' : '▼' }}
                    </span>
                  </th>

                  <th class="th-right" style="cursor: pointer;" (click)="sortData('completedFollowUps')">
                    Completed Followups
                    <span *ngIf="sortColumn === 'completedFollowUps' && sortDirection !== 'default'">
                      {{ sortDirection === 'asc' ? '▲' : '▼' }}
                    </span>
                  </th>


                  <th class="th-right" style="cursor: pointer;" (click)="sortData('openFollowUps')">
                    Upcoming followups
                    <span *ngIf="sortColumn === 'openFollowUps' && sortDirection !== 'default'">
                      {{ sortDirection === 'asc' ? '▲' : '▼' }}
                    </span>
                  </th>

                  <th class="th-right" style="cursor: pointer;" (click)="sortData('closedFollowUps')">
                    Overdue followups
                    <span *ngIf="sortColumn === 'closedFollowUps' && sortDirection !== 'default'">
                      {{ sortDirection === 'asc' ? '▲' : '▼' }}
                    </span>
                  </th>

                 
                  <th class="th-right" style="cursor: pointer;" (click)="sortData('saTestDrives')">
                    SA Test Drives
                    <span *ngIf="sortColumn === 'saTestDrives' && sortDirection !== 'default'">
                      {{ sortDirection === 'asc' ? '▲' : '▼' }}
                    </span>
                  </th>

                  <th class="th-right" style="cursor: pointer;" (click)="sortData('cxpTestDrives')">
                    sync to CXP
                    <span *ngIf="sortColumn === 'cxpTestDrives' && sortDirection !== 'default'">
                      {{ sortDirection === 'asc' ? '▲' : '▼' }}
                    </span>
                  </th>
                  <th class="th-right" style="cursor: pointer;" (click)="sortData('completedTestDrives')">
                    Completed test drives
                    <span *ngIf="sortColumn === 'completedTestDrives' && sortDirection !== 'default'">
                      {{ sortDirection === 'asc' ? '▲' : '▼' }}
                    </span>
                  </th>

                  <th class="th-right" style="cursor: pointer;" (click)="sortData('upcomingTestDrives')">
                    Upcoming
                    <span *ngIf="sortColumn === 'upcomingTestDrives' && sortDirection !== 'default'">
                      {{ sortDirection === 'asc' ? '▲' : '▼' }}
                    </span>
                  </th>
                  <th class="th-right" style="cursor: pointer;" (click)="sortData('closedTestDrives')">
                    Overdue
                    <span *ngIf="sortColumn === 'closedTestDrives' && sortDirection !== 'default'">
                      {{ sortDirection === 'asc' ? '▲' : '▼' }}
                    </span>
                  </th>
                  <th class="th-right" style="cursor: pointer;" (click)="sortData('opportunitiesConverted')">
                    Opportunities Converted
                    <span *ngIf="sortColumn === 'opportunitiesConverted' && sortDirection !== 'default'">
                      {{ sortDirection === 'asc' ? '▲' : '▼' }}
                    </span>
                  </th>

                </tr>
              </thead> -->
              <thead class="table-thead">
                <tr>
                  <th rowspan="2" class="sticky-col-header th-left">Dealer</th>
                  <th colspan="2" class="th-right">Users</th>
                  <th colspan="4" class="th-right">Leads</th>
                  <th colspan="5" class="th-right">Follow-ups</th>
                  <th colspan="6" class="th-right">Test Drives</th>
                </tr>
                <tr>
                  <!-- Users -->
                  <th class="th-right" style="cursor:pointer;" (click)="sortData('totalUsers')">Total
                    <span *ngIf="sortColumn==='totalUsers' && sortDirection!=='default'">{{
                      sortDirection==='asc'?'▲':'▼' }}</span>
                  </th>
                  <th class="th-right group-divider" style="cursor:pointer;" (click)="sortData('activeUsers')">Active
                    <span *ngIf="sortColumn==='activeUsers' && sortDirection!=='default'">{{
                      sortDirection==='asc'?'▲':'▼' }}</span>
                  </th>

                  <!-- Leads -->
                  <th class="th-right" style="cursor:pointer;" (click)="sortData('saLeads')">SA
                    <span *ngIf="sortColumn==='saLeads' && sortDirection!=='default'">{{ sortDirection==='asc'?'▲':'▼'
                      }}</span>
                  </th>
                  <th class="th-right" style="cursor:pointer;" (click)="sortData('cxpLeads')">Sync with CXP
                    <span *ngIf="sortColumn==='cxpLeads' && sortDirection!=='default'">{{ sortDirection==='asc'?'▲':'▼'
                      }}</span>
                  </th>
                  <th class="th-right" style="cursor:pointer;" (click)="sortData('icsLeads')">Sync with ICS
                    <span *ngIf="sortColumn==='icsLeads' && sortDirection!=='default'">{{ sortDirection==='asc'?'▲':'▼'
                      }}</span>
                  </th>
                  <th class="th-right  group-divider" style="cursor:pointer;"
                    (click)="sortData('manuallyEnteredLeads')">Manually Entered with CXP
                    <span *ngIf="sortColumn==='manuallyEnteredLeads' && sortDirection!=='default'">{{
                      sortDirection==='asc'?'▲':'▼'
                      }}</span>
                  </th>

                  <!-- Followups -->
                  <th class="th-right" style="cursor:pointer;" (click)="sortData('saFollowUps')">SA
                    <span *ngIf="sortColumn==='saFollowUps' && sortDirection!=='default'">{{
                      sortDirection==='asc'?'▲':'▼' }}</span>
                  </th>
                  <th class="th-right" style="cursor:pointer;" (click)="sortData('cxpFollowUps')">Sync with CXP
                    <span *ngIf="sortColumn==='cxpFollowUps' && sortDirection!=='default'">{{
                      sortDirection==='asc'?'▲':'▼' }}</span>
                  </th>
                  <th class="th-right" style="cursor:pointer;" (click)="sortData('completedFollowUps')">Completed
                    <span *ngIf="sortColumn==='completedFollowUps' && sortDirection!=='default'">{{
                      sortDirection==='asc'?'▲':'▼'
                      }}</span>
                  </th>
                  <th class="th-right" style="cursor:pointer;" (click)="sortData('openFollowUps')">Upcoming
                    <span *ngIf="sortColumn==='openFollowUps' && sortDirection!=='default'">{{
                      sortDirection==='asc'?'▲':'▼' }}</span>
                  </th>
                  <th class="th-right  group-divider" style="cursor:pointer;" (click)="sortData('closedFollowUps')">
                    Overdue
                    <span *ngIf="sortColumn==='closedFollowUps' && sortDirection!=='default'">{{
                      sortDirection==='asc'?'▲':'▼'
                      }}</span>
                  </th>

                  <!-- Test Drives -->
                  <th class="th-right" style="cursor:pointer;" (click)="sortData('saTestDrives')">SA
                    <span *ngIf="sortColumn==='saTestDrives' && sortDirection!=='default'">{{
                      sortDirection==='asc'?'▲':'▼' }}</span>
                  </th>
                  <th class="th-right" style="cursor:pointer;" (click)="sortData('cxpTestDrives')">Sync with CXP
                    <span *ngIf="sortColumn==='cxpTestDrives' && sortDirection!=='default'">{{
                      sortDirection==='asc'?'▲':'▼' }}</span>
                  </th>
                  <th class="th-right" style="cursor:pointer;" (click)="sortData('completedTestDrives')">Completed
                    <span *ngIf="sortColumn==='completedTestDrives' && sortDirection!=='default'">{{
                      sortDirection==='asc'?'▲':'▼'
                      }}</span>
                  </th>
                  <th class="th-right" style="cursor:pointer;" (click)="sortData('upcomingTestDrives')">Upcoming
                    <span *ngIf="sortColumn==='upcomingTestDrives' && sortDirection!=='default'">{{
                      sortDirection==='asc'?'▲':'▼'
                      }}</span>
                  </th>
                  <th class="th-right  group-divider" style="cursor:pointer;" (click)="sortData('closedTestDrives')">
                    Overdue
                    <span *ngIf="sortColumn==='closedTestDrives' && sortDirection!=='default'">{{
                      sortDirection==='asc'?'▲':'▼'
                      }}</span>
                  </th>
                  <th class="th-right" style="cursor:pointer;" (click)="sortData('opportunitiesConverted')">
                    Opportunities Converted
                    <span *ngIf="sortColumn==='opportunitiesConverted' && sortDirection!=='default'">{{
                      sortDirection==='asc'?'▲':'▼'
                      }}</span>
                  </th>
                </tr>
              </thead>

              <tbody>
                <ng-container
                  *ngFor="let dealer of (selectedDealers.length > 0 ? selectedDealers : dealers) | slice:0:table1Length; let i = index">
                  <tr *ngIf="dealer" class="table-row">
                    <td class="sticky-col-header  td-left">
                      <button class="expand-btn" (click)="toggleRow($event, dealer, 'engagement-' + i)">
                        <span class="arrow">{{ expandedRow === 'engagement-' + i ? 'v' : '>' }}</span>
                        {{ dealer.dealerName }}
                      </button>
                    </td>
                    <td class="td-right">{{ dealer.totalUsers ?? 0 }}</td>
                    <td class="td-right">{{ dealer.activeUsers ?? 0 }}</td>

                    <td class="td-right" style="color:#222fb9">{{ dealer.saLeads ?? 0 }}</td>
                    <td class="td-right" [ngStyle]="{'color': dealer.saLeads === dealer.cxpLeads ? 'green' : 'red'}">
                      {{ dealer.cxpLeads ?? 0 }}
                    </td>
                    <td class="td-right">{{ dealer.icsLeads ?? 0 }}</td>
                    <td class="td-right">{{ dealer.manuallyEnteredLeads ?? 0 }}</td>



                    <td class="td-right" style="color:#222fb9">{{ dealer.saFollowUps ?? 0 }}</td>
                    <!-- SA FOLLOWUPS -->
                    <td class="td-right"
                      [ngStyle]="{'color': dealer.saFollowUps === dealer.cxpFollowUps ? 'green' : 'red'}">
                      {{ dealer.cxpFollowUps ?? 0 }}
                    </td>

                    <td class="td-right">{{ dealer.completedFollowUps ?? 0 }}</td>
                    <!-- Compeplteted followups -->

                    <td class="td-right">{{ dealer.openFollowUps ?? 0 }}</td>
                    <td class="td-right">{{ dealer.closedFollowUps ?? 0 }}</td>
                    <!-- <td class="td-right">{{ dealer.cxpFollowUps ?? 0 }}</td> -->

                    <td class="td-right" style="color:#222fb9">{{ dealer.saTestDrives ?? 0 }}</td>
                    <td class="td-right"
                      [ngStyle]="{'color': dealer.saTestDrives === dealer.cxpTestDrives ? 'green' : 'red'}">
                      {{ dealer.cxpTestDrives ?? 0 }}
                    </td>
                    <td class="td-right">{{ dealer.completedTestDrives ?? 0 }}</td>
                    <td class="td-right">{{ dealer.upcomingTestDrives ?? 0 }}</td>
                    <!-- upcomingtestfrives -->
                    <td class="td-right">{{ dealer.closedTestDrives ?? 0 }}</td>
                    <!-- <td class="td-right">{{ dealer.uniqueTestDrives ?? 0 }}</td> -->
                    <!-- <td class="td-right">{{ dealer.cxpTestDrives ?? 0 }}</td> -->

                    <td class="td-right">{{ dealer.opportunitiesConverted ?? 0 }}</td>

                  </tr>

                  <!-- Sub Row -->
                  <tr *ngIf="expandedRow === 'engagement-' + i" class="sub-row">
                    <td colspan="18" class="sub-row-content">
                      <div class="sub-row-inner">
                        <div class="sub-row-title" style="text-align: left;">
                          User-wise details — {{ dealer.dealerName }}
                        </div>
                        <div class="sub-table-container">
                          <div class="sub-table-scroll">

                            <table class="sub-table">
                              <thead class="sub-table-thead">
                                <tr>
                                  <th style="text-align:left">User</th>
                                  <th>Active</th>

                                  <th>SA Leads</th>
                                  <th>Sync with CXP</th>
                                  <th>Sync with ICS</th>
                                  <th>Manually Entered with CXP</th>

                                  <th>SA Follow-ups</th>
                                  <th>Sync with CXP</th>
                                  <th>Completed</th>

                                  <th>Upcoming</th>
                                  <th>Overdue</th>
                                  <!-- <th>Follow-ups (CXP)</th> -->


                                  <th>SA Test Drives</th>
                                  <th>Sync with CXP</th>

                                  <th>Upcoming </th>
                                  <th>Completed </th>
                                  <th>Overdue</th>
                                  <th>Opportunities Converted</th>
                                </tr>
                              </thead>
                              <tbody>
                                <tr *ngFor="let user of getSortedUsers(dealer.dealerId)">
                                  <td style="text-align:left">
                                    {{ user.user }} <span *ngIf="user.user_role">({{ user.user_role }})</span>
                                  </td>
                                  <td class="td-center">
                                    <span class="chip" [ngClass]="user.active ? 'chip-success' : 'chip-inactive'">
                                      {{ user.active ? 'Active' : 'Inactive' }}
                                    </span>
                                  </td>
                                  <td class="td-right">{{ user.leads?.sa ?? 0 }}</td>
                                  <td class="td-right">{{ user.leads?.cxp ?? 0 }}</td>
                                  <td class="td-right">{{ user.leads?.ics ?? 0 }}</td>
                                  <td class="td-right">{{ user.leads?.manuallyEntered ?? 0 }}</td>


                                  <td class="td-right">{{ user.followups?.sa ?? 0 }}</td>
                                  <td class="td-right">{{ user.followups?.cxp ?? 0 }}</td>
                                  <td class="td-right">{{ user.followups?.completed ?? 0 }}</td>
                                  <td class="td-right">{{ user.followups?.open ?? 0 }}</td>
                                  <td class="td-right">{{ user.followups?.closed ?? 0 }}</td>


                                  <td class="td-right">{{ user.testdrives?.sa ?? 0 }}</td>
                                  <td class="td-right">{{ user.testdrives?.cxp ?? 0 }}</td>

                                  <!-- <td class="td-right">{{ user.testdrives?.unique ?? 0 }}</td> -->
                                  <td class="td-right">{{ user.testdrives?.completed ?? 0 }}</td>
                                  <td class="td-right">{{ user.testdrives?.upcoming ?? 0 }}</td>

                                  <td class="td-right">{{ user.testdrives?.closed ?? 0 }}</td>

                                  <td class="td-right">{{ user.opportunitiesConverted ?? 0 }}</td>

                                </tr>
                                <tr *ngIf="!dealerUsers[dealer.dealerId] || dealerUsers[dealer.dealerId]?.length === 0">
                                  <td colspan="14" class="td-center">No Users Found</td>
                                </tr>
                              </tbody>
                            </table>
                          </div>
                        </div>
                      </div>
                    </td>
                  </tr>
                </ng-container>
              </tbody>
            </table>
          </div>
          <!-- Show More button -->
          <button type="button" style="margin: 0.5rem; float: right;" class="btn btn-primary" (click)="showMoreTable1()"
            *ngIf="table1Length < (selectedDealers.length > 0 ? selectedDealers.length : dealers.length)">
            Show More
          </button>
          <!-- Show Less button -->
          <button type="button" style="margin: 0.5rem; float: right;" class="btn btn-secondary"
            (click)="showLessTable1()"
            *ngIf="table1Length > 5 && (selectedDealers.length > 0 ? selectedDealers.length : dealers.length) > 5">
            Show Less
          </button>
        </div>
      </div>
      <!-- Table 2 -->
      <div class="table-section">
        <div class="table-header">
          <div>
            <h2 class="table-title">Dealer Summary — Calls</h2>
            <p class="table-subtitle">Call volumes and outcomes</p>
          </div>
          <div class="table-actions">
            <div class="nav-button-group" style="margin-left:10px;">

              <button class="nav-button" [ngClass]="{ 'active': dealerSummaryCallsViewType === 'table' }"
                (click)="dealerEngagementView('table')">
                <i class="fas fa-table" style="margin-right: 6px; font-size:15px;"></i> Table
              </button>

              <button class="nav-button" [ngClass]="{ 'active': dealerSummaryCallsViewType === 'chart' }"
                (click)="dealerEngagementView('chart')">
                <i class="fas fa-chart-line" style="margin-right: 8px;"></i> Line Chart
              </button>
            </div>
            <button class="btn btn-small btn-secondary" (click)="exportDealerCalllogstocxp()">
              <i class="icon-download"></i> Export CSV
            </button>

          </div>
        </div>
        <!-- Table View -->
        <div *ngIf="dealerSummaryCallsViewType === 'table'" class="table-container">
          <div class="table-scroll">
            <table class="data-table calls-table">
              <thead class="table-thead">
                <tr>
                  <th class="sticky-col-header th-left" style="width:18%">Dealer</th>
                  <th class="th-right">Total Calls</th>
                  <th class="th-right">Outgoing</th>
                  <th class="th-right">Incoming</th>
                  <th class="th-right">Connected</th>
                  <th class="th-right">Declined</th>
                  <th class="th-right th-rounded-right">Duration</th>
                </tr>
              </thead>
              <tbody>
                <ng-container *ngFor="let dealer of dealers | slice:0:table2Length; let i = index">
                  <!-- Main dealer row -->
                  <tr>
                    <td class="sticky-col td-font-medium">
                      <button class="expand-btn" (click)="toggleRow($event, dealer, 'engagement-' + i)">
                        <span class="arrow">{{ expandedRow === 'engagement-' + i ? 'v' : '>' }}</span>
                        {{ dealer.dealerName }}
                      </button>
                    </td>
                    <td>
                      <i class="fa fa-phone" style="margin-right: 4px; color: black;"></i>
                      {{ dealer.callLogs?.totalCalls || 0 }}
                    </td>
                    <!-- <td>{{ dealer.callLogs?.outgoing || 0 }}</td>
                    <td>{{ dealer.callLogs?.incoming || 0 }}</td>
                    <td>{{ dealer.callLogs?.connected || 0 }}</td>
                    <td>{{ dealer.callLogs?.declined || 0 }}</td> -->
                    <!-- Outgoing Call -->
                    <!-- Outgoing Call -->
                    <!-- Outgoing Call -->
                    <td>
                      <span style="color: green; margin-right: 4px; font-size: 18px;">&#8593;</span> <!-- ↑ -->
                      <span style="color: green;">{{ dealer.callLogs?.outgoing || 0 }}</span>
                    </td>

                    <!-- Incoming Call -->
                    <td>
                      <span style="color: green; margin-right: 4px; font-size: 18px;">&#8595;</span> <!-- ↓ -->
                      <span style="color: green;">{{ dealer.callLogs?.incoming || 0 }}</span>
                    </td>
                    <!-- Connected Call -->
                    <!-- Connected Call -->
                    <td>
                      <span style="
                      display: inline-flex;
                      justify-content: center;
                      align-items: center;
                      width: 16px;
                      height: 16px;
                      border-radius: 50%;
                      background-color: #007bff; /* blue */
                      color: white;
                      font-size: 10px;
                      margin-right: 4px;
                    ">
                        &#10003; <!-- check mark -->
                      </span>
                      <span style="color: #007bff;">{{ dealer.callLogs?.connected || 0 }}</span>
                    </td>

                    <!-- Declined Call -->
                    <td>
                      <span style="
                      display: inline-flex;
                      justify-content: center;
                      align-items: center;
                      width: 16px;
                      height: 16px;
                      border-radius: 50%;
                      background-color: red;
                      color: white;
                      font-size: 10px;
                      margin-right: 4px;
                    ">
                        &times; <!-- cross mark -->
                      </span>
                      <span style="color: red;">{{ dealer.callLogs?.declined || 0 }}</span>
                    </td>

                    <!-- <td>{{ dealer.callLogs?.durationSec || '00:00:00' }}</td> -->
                    <td>{{ dealer.callLogs?.durationSec ? formatDuration(dealer.callLogs.durationSec) : '00:00:00' }}
                    </td>

                  </tr>
                  <!-- Sub-row: user call logs -->
                  <tr *ngIf="expandedRow === 'engagement-' + i">
                    <td colspan="7">
                      <div class="sub-table-container">
                        <div class="sub-user-table-scroll">
                          <table class="sub-table calls-sub-table">
                            <thead>
                              <tr>
                                <th style="text-align:left;width:15%">User</th>
                                <th>Total</th>
                                <th>Outgoing</th>
                                <th>Incoming</th>
                                <th>Connected</th>
                                <th>Declined</th>
                                <th>Duration</th>
                              </tr>
                            </thead>
                            <tbody>
                              <tr *ngFor="let userCall of userCallLogs[dealer.dealerId]">
                                <td style="text-align:left">{{ userCall.name }}</td>
                                <td>{{ userCall.calls.total }}</td>
                                <td>{{ userCall.calls.outgoing }}</td>
                                <td>{{ userCall.calls.incoming }}</td>
                                <td>{{ userCall.calls.connected }}</td>
                                <td>{{ userCall.calls.declined }}</td>
                                <td>{{ userCall.calls.duration }}</td>
                              </tr>
                              <tr *ngIf="!userCallLogs[dealer.dealerId] || userCallLogs[dealer.dealerId]?.length === 0">
                                <td colspan="7" style="text-align: center; font-style: italic;">
                                  No call logs found
                                </td>
                              </tr>
                            </tbody>
                          </table>
                        </div>
                      </div>
                    </td>
                  </tr>
                </ng-container>
              </tbody>
            </table>
            <!-- Show More / Show Less buttons -->
            <div style="display:flex; justify-content:flex-end; gap:0.5rem; margin-top:0.5rem;">
              <button type="button" class="btn btn-primary" (click)="showMoreTable2()"
                *ngIf="table2Length < dealers.length">
                Show More
              </button>
              <button type="button" class="btn btn-secondary" (click)="showLessTable2()"
                *ngIf="table2Length > 5 && dealers.length > 5">
                Show Less
              </button>
            </div>
          </div>
        </div>
        <!-- Chart View -->
        <div *ngIf="dealerSummaryCallsViewType === 'chart'" class="chart-container"
          style="min-height:400px; padding:20px; background:white; border-radius:10px;">
          <div id="chart">
            <apx-chart [series]="chartOptions.series!" [chart]="chartOptions.chart!" [xaxis]="chartOptions.xaxis!"
              [stroke]="chartOptions.stroke!" [dataLabels]="chartOptions.dataLabels!" [title]="chartOptions.title!">
            </apx-chart>
          </div>
        </div>
      </div>
    </main>
  </div>
</ng-container>
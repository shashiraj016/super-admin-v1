<ng-container *ngIf="!selectedDealer && !selectedSM">
  <div *ngIf="isLoading" class="loader-overlay">
    <div class="spinner"></div>
  </div>
  <div class="header2" [ngClass]="{ 'sidebar-open': isSidebarOpen, 'sidebar-closed': !isSidebarOpen }"
    style="border-radius:7px;padding:10px;margin-top:1rem;">
    <div class="fltt">

      <select [(ngModel)]="selectedFilter" (change)="onFilterChange(selectedFilter)" class="time-dropdown flt1"
        style="margin-right: 5px;">
        <option value="DAY">Today</option>
        <option value="YESTERDAY">Yesterday</option>
        <option value="WEEK">This Week</option>
        <option value="LAST_WEEK">Last Week</option>
        <option value="MTD">This Month</option>
        <option value="LAST_MONTH">Last Month</option>
        <option value="QTD">This Quarter</option>
        <option value="LAST_QUARTER">Last Quarter</option>
        <option value="SIX_MONTH">Last 6 Months</option>
        <option value="YTD">This Year</option>
        <option value="LIFETIME">Lifetime</option>
        <option value="CUSTOM">Custom</option>
      </select>
      <div *ngIf="selectedFilter === 'CUSTOM'" class="custom-inputs flt1">
        <input type="date" [(ngModel)]="customStartDate" placeholder="Start Date" class="custom-date"
          (change)="validateCustomDates()" />
        <input type="date" [(ngModel)]="customEndDate" placeholder="End Date" class="custom-date"
          (change)="validateCustomDates()" />
        <button (click)="applyCustomDate()" class="apply-btn flt2">Apply</button>
        <button (click)="resetCustomDate()" class="reset-btn flt2">Reset</button>
      </div>
      <div class="dropdown flt1" [class.show]="dropdownOpen" style="margin-right: 5px;">
        <button class="time-dropdown dropdown-toggle" type="button" (click)="toggleDropdown()"
          [disabled]="selectedFilter === 'CUSTOM' && invalidDateRange">
          {{ selectedDealers.length > 0 ? 'Dealers Selected (' + selectedDealers.length + ')' : 'Select Dealers' }}
        </button>
        <div class="dropdown-menu show" *ngIf="dropdownOpen">
          <div class="px-2 py-1">
            <input type="text" class="form-control" placeholder="Search dealers..." [(ngModel)]="dealerSearch"
              (input)="filterDealers()" (click)="$event.stopPropagation()" />
          </div>

          <div class="d-flex justify-content-between align-items-center px-2 py-1 border-bottom">
            <label class="mb-0 d-flex align-items-center" (click)="$event.stopPropagation()">
              <input type="checkbox" class="me-2" [checked]="areAllSelected()"
                (change)="toggleSelectAll($event); $event.stopPropagation()" />
              Select All
            </label>
            <button type="button" class="btn btn-link btn-sm text-danger p-0 ms-auto" id="clearbtn"
              style="margin-left:120px;" (click)="clearSelection(); $event.stopPropagation()">
              Clear
            </button>
          </div>

          <ng-container *ngIf="filteredDealers.length > 0; else noDealers">
            <!-- <div *ngFor="let dealer of filteredDealers" class="dropdown-item d-flex align-items-center"
              (click)="toggleDealerSelection(dealer); $event.stopPropagation()">

              <input type="checkbox" class="me-2" [checked]="isDealerSelected(dealer)" style="border:1px solid black"
                (click)="$event.stopPropagation()" />

              {{ dealer.dealerName }}
            </div> -->
            <!-- <div *ngFor="let dealer of filteredDealers" class="dropdown-item d-flex align-items-center"
              (click)="$event.stopPropagation()"> -->
            <div *ngFor="let dealer of filteredDealers; trackBy: trackByDealerId" class="dropdown-item">


              <input type="checkbox" class="me-2" [checked]="isDealerSelected(dealer)" style="border:1px solid black"
                (change)="toggleDealerSelection(dealer); $event.stopPropagation()" />

              <span (click)="toggleDealerSelection(dealer); $event.stopPropagation()">
                {{ dealer.dealerName }}
              </span>
            </div>
          </ng-container>

          <ng-template #noDealers>
            <div class="dropdown-item text-muted text-center">
              No dealers found
            </div>
          </ng-template>
        </div>
      </div>
    </div>
  </div>

  <div class="content-section active" style="margin-bottom: 2rem;">
    <main class="main-content">
      <section class="kpi-section">

        <div class="kpi-card">
          <div class="kpi-label">Active Network:</div>
          <div class="kpi-value" style="color:black;">{{ kpiData?.activeNetwork }}</div>
          <div class="kpi-secondary">Dealers: <span class="kpi-highlight">{{ kpiData?.dealers }}</span></div>
        </div>

        <!-- <div class="kpi-card">
          <div class="kpi-label">Users</div>
          <div class="kpi-value" style="color:black;">{{ kpiData?.users }}</div>
          <div class="kpi-secondary">Active: <span class="kpi-highlight">{{ kpiData?.activeUsers }}</span></div>
        </div> -->
        <div class="kpi-card">
          <div class="kpi-label">Active</div>
          <div class="kpi-value" style="color:black;">{{ kpiData?.activeUsers }}</div>
          <div class="kpi-secondary">Users: <span class="kpi-highlight">{{ kpiData?.users }}</span></div>
        </div>

        <div class="kpi-card">
          <div class="kpi-label">Leads</div>
          <div class="kpi-value" style="color:black;">{{ kpiData?.leads }}</div>
          <div class="kpi-secondary">Across all dealers</div>
        </div>

        <div class="kpi-card">
          <div class="kpi-label">Calls</div>
          <div class="kpi-value" style="color:black;">{{ kpiData?.calls }}</div>
          <div class="kpi-secondary">Total volume</div>
        </div>

        <div class="kpi-card">
          <div class="kpi-label">Total Followups</div>
          <div class="kpi-value" style="color:black;">{{ kpiData?.totalFollowUps }}</div>
        </div>

        <div class="kpi-card">
          <div class="kpi-label">Unique / Completed Test Drives</div>
          <div class="kpi-value" style="color:black;">
            {{ kpiData?.uniqueTestDrives }} / {{ kpiData?.completedTestDrives }}
          </div>
        </div>

      </section>
      <!-- Side by Side Charts -->
      <!-- <div class="charts-container">
        <div class="chart-card">
          <div class="chart-title">Enquiries</div>
          <div class="chart-content">
            <div class="chart-row">
              <div class="chart-label">Total</div>
              <div class="chart-bar-container">
                <div class="chart-bar" style="width: 60%;">
                  <div class="chart-target" style="left: 100%;" data-value="30"></div>
                </div>
              </div>
              <div class="chart-value">18</div>
            </div>
            <div class="chart-row">
              <div class="chart-label">Connected</div>
              <div class="chart-bar-container">
                <div class="chart-bar" style="width: 80%;">
                  <div class="chart-target" style="left: 100%;" data-value="15"></div>
                </div>
              </div>
              <div class="chart-value">12</div>
            </div>
          </div>
        </div>

        <div class="chart-card">
          <div class="chart-title">Cold Calls</div>
          <div class="chart-content">
            <div class="chart-row">
              <div class="chart-label">Total</div>
              <div class="chart-bar-container">
                <div class="chart-bar" style="width: 100%;">
                  <div class="chart-target" style="left: 67%;" data-value="30"></div>
                </div>
              </div>
              <div class="chart-value">45</div>
            </div>
            <div class="chart-row">
              <div class="chart-label">Connected</div>
              <div class="chart-bar-container">
                <div class="chart-bar" style="width: 93%;">
                  <div class="chart-target" style="left: 54%;" data-value="15"></div>
                </div>
              </div>
              <div class="chart-value">28</div>
            </div>
          </div>
        </div>
      </div> -->

      <div class="table-section">
        <div class="table-header">
          <div>
            <h2 class="table-title">Dealer Summary — Engagement</h2>
            <p class="table-subtitle">Users, Leads, Follow-ups, Test Drives (with CXP/ICS sync)</p>
          </div>

          <div class="table-actions flex items-center gap-2">


            <!-- Export CSV button -->
            <button type="button" class="btn btn-small btn-secondary" id="exportsummary" (click)="exportToCSV()">
              <i class="icon-download"></i> Export CSV
            </button>
          </div>
        </div>

        <div class="table-container">
          <div class="table-scroll">
            <table class="data-table">
              <thead class="table-thead">
                <tr>
                  <th rowspan="2" class="sticky-col-header th-left">Dealer</th>
                  <th colspan="2" class="th-right ">Users</th>
                  <th colspan="4" class="th-right">Leads</th>
                  <th colspan="5" class="th-right">Follow-ups</th>
                  <th colspan="6" class="th-right">Test Drives</th>
                </tr>
                <tr>
                  <!-- Users -->
                  <!-- <th class="th-right" style="cursor:pointer;" (click)="sortData('totalUsers')">Total
                    <span *ngIf="sortColumn==='totalUsers' && sortDirection!=='default'">{{
                      sortDirection==='asc'?'▲':'▼' }}</span>
                  </th> -->
                  <th class="th-right sortable-header" style="cursor:pointer;" (click)="sortData('totalUsers')">
                    Total
                    <span class="sort-arrows">
                      <span class="arrow-up"
                        [class.active]="sortColumn==='totalUsers' && sortDirection==='asc'">▲</span>
                      <span class="arrow-down"
                        [class.active]="sortColumn==='totalUsers' && sortDirection==='desc'">▼</span>
                    </span>
                  </th>

                  <!-- <th class="th-right group-divider" style="cursor:pointer;" (click)="sortData('activeUsers')">
                    Registered Users
                    <span *ngIf="sortColumn==='activeUsers' && sortDirection!=='default'">{{
                      sortDirection==='asc'?'▲':'▼' }}</span>
                  </th>

                  <th class="th-right" style="cursor:pointer;" (click)="sortData('saLeads')">SA
                    <span *ngIf="sortColumn==='saLeads' && sortDirection!=='default'">{{ sortDirection==='asc'?'▲':'▼'
                      }}</span>
                  </th>
                  <th class="th-right" style="cursor:pointer;" (click)="sortData('cxpLeads')">Sync with CXP
                    <span *ngIf="sortColumn==='cxpLeads' && sortDirection!=='default'">{{ sortDirection==='asc'?'▲':'▼'
                      }}</span>
                  </th>
                  <th class="th-right" style="cursor:pointer;" (click)="sortData('icsLeads')">Sync with ICS
                    <span *ngIf="sortColumn==='icsLeads' && sortDirection!=='default'">{{ sortDirection==='asc'?'▲':'▼'
                      }}</span>
                  </th>
                  <th class="th-right  group-divider" style="cursor:pointer;"
                    (click)="sortData('manuallyEnteredLeads')">Manually Entered with CXP
                    <span *ngIf="sortColumn==='manuallyEnteredLeads' && sortDirection!=='default'">{{
                      sortDirection==='asc'?'▲':'▼'
                      }}</span>
                  </th>

                  <th class="th-right" style="cursor:pointer;" (click)="sortData('saFollowUps')">SA
                    <span *ngIf="sortColumn==='saFollowUps' && sortDirection!=='default'">{{
                      sortDirection==='asc'?'▲':'▼' }}</span>
                  </th>
                  <th class="th-right" style="cursor:pointer;" (click)="sortData('cxpFollowUps')">Sync with CXP
                    <span *ngIf="sortColumn==='cxpFollowUps' && sortDirection!=='default'">{{
                      sortDirection==='asc'?'▲':'▼' }}</span>
                  </th>
                  <th class="th-right" style="cursor:pointer;" (click)="sortData('completedFollowUps')">Completed
                    <span *ngIf="sortColumn==='completedFollowUps' && sortDirection!=='default'">{{
                      sortDirection==='asc'?'▲':'▼'
                      }}</span>
                  </th>
                  <th class="th-right" style="cursor:pointer;" (click)="sortData('openFollowUps')">Upcoming
                    <span *ngIf="sortColumn==='openFollowUps' && sortDirection!=='default'">{{
                      sortDirection==='asc'?'▲':'▼' }}</span>
                  </th>
                  <th class="th-right  group-divider" style="cursor:pointer;" (click)="sortData('closedFollowUps')">
                    Overdue
                    <span *ngIf="sortColumn==='closedFollowUps' && sortDirection!=='default'">{{
                      sortDirection==='asc'?'▲':'▼'
                      }}</span>
                  </th>

                  <th class="th-right" style="cursor:pointer;" (click)="sortData('saTestDrives')">SA
                    <span *ngIf="sortColumn==='saTestDrives' && sortDirection!=='default'">{{
                      sortDirection==='asc'?'▲':'▼' }}</span>
                  </th>
                  <th class="th-right" style="cursor:pointer;" (click)="sortData('cxpTestDrives')">Sync with CXP
                    <span *ngIf="sortColumn==='cxpTestDrives' && sortDirection!=='default'">{{
                      sortDirection==='asc'?'▲':'▼' }}</span>
                  </th>
                  <th class="th-right" style="cursor:pointer;" (click)="sortData('completedTestDrives')">Completed
                    <span *ngIf="sortColumn==='completedTestDrives' && sortDirection!=='default'">{{
                      sortDirection==='asc'?'▲':'▼'
                      }}</span>
                  </th>
                  <th class="th-right" style="cursor:pointer;" (click)="sortData('upcomingTestDrives')">Upcoming
                    <span *ngIf="sortColumn==='upcomingTestDrives' && sortDirection!=='default'">{{
                      sortDirection==='asc'?'▲':'▼'
                      }}</span>
                  </th>
                  <th class="th-right  group-divider" style="cursor:pointer;" (click)="sortData('closedTestDrives')">
                    Overdue
                    <span *ngIf="sortColumn==='closedTestDrives' && sortDirection!=='default'">{{
                      sortDirection==='asc'?'▲':'▼'
                      }}</span>
                  </th>
                  <th class="th-right" style="cursor:pointer;" (click)="sortData('opportunitiesConverted')">
                    Opportunities Converted
                    <span *ngIf="sortColumn==='opportunitiesConverted' && sortDirection!=='default'">{{
                      sortDirection==='asc'?'▲':'▼'
                      }}</span>
                  </th> -->
                  <th class="th-right  sortable-header" style="cursor:pointer;" (click)="sortData('registerUsers')">
                    Registered
                    <span class="sort-arrows">
                      <span class="arrow-up"
                        [class.active]="sortColumn==='registerUsers' && sortDirection==='asc'">▲</span>
                      <span class="arrow-down"
                        [class.active]="sortColumn==='registerUsers' && sortDirection==='desc'">▼</span>
                    </span>
                  </th>
                  <th class="th-right group-divider sortable-header" style="cursor:pointer;"
                    (click)="sortData('activeUsers')">
                    Active
                    <span class="sort-arrows">
                      <span class="arrow-up"
                        [class.active]="sortColumn==='activeUsers' && sortDirection==='asc'">▲</span>
                      <span class="arrow-down"
                        [class.active]="sortColumn==='activeUsers' && sortDirection==='desc'">▼</span>
                    </span>
                  </th>

                  <!-- Leads -->
                  <th class="th-right sortable-header" style="cursor:pointer;" (click)="sortData('saLeads')">
                    SA
                    <span class="sort-arrows">
                      <span class="arrow-up" [class.active]="sortColumn==='saLeads' && sortDirection==='asc'">▲</span>
                      <span class="arrow-down"
                        [class.active]="sortColumn==='saLeads' && sortDirection==='desc'">▼</span>
                    </span>
                  </th>

                  <th class="th-right sortable-header" style="cursor:pointer;" (click)="sortData('cxpLeads')">
                    Sync with CXP
                    <span class="sort-arrows">
                      <span class="arrow-up" [class.active]="sortColumn==='cxpLeads' && sortDirection==='asc'">▲</span>
                      <span class="arrow-down"
                        [class.active]="sortColumn==='cxpLeads' && sortDirection==='desc'">▼</span>
                    </span>
                  </th>

                  <th class="th-right sortable-header" style="cursor:pointer;" (click)="sortData('icsLeads')">
                    Sync with ICS
                    <span class="sort-arrows">
                      <span class="arrow-up" [class.active]="sortColumn==='icsLeads' && sortDirection==='asc'">▲</span>
                      <span class="arrow-down"
                        [class.active]="sortColumn==='icsLeads' && sortDirection==='desc'">▼</span>
                    </span>
                  </th>

                  <th class="th-right group-divider sortable-header" style="cursor:pointer;"
                    (click)="sortData('manuallyEnteredLeads')">
                    Manually Entered with CXP
                    <span class="sort-arrows">
                      <span class="arrow-up"
                        [class.active]="sortColumn==='manuallyEnteredLeads' && sortDirection==='asc'">▲</span>
                      <span class="arrow-down"
                        [class.active]="sortColumn==='manuallyEnteredLeads' && sortDirection==='desc'">▼</span>
                    </span>
                  </th>

                  <!-- Followups -->
                  <th class="th-right sortable-header" style="cursor:pointer;" (click)="sortData('saFollowUps')">
                    SA
                    <span class="sort-arrows">
                      <span class="arrow-up"
                        [class.active]="sortColumn==='saFollowUps' && sortDirection==='asc'">▲</span>
                      <span class="arrow-down"
                        [class.active]="sortColumn==='saFollowUps' && sortDirection==='desc'">▼</span>
                    </span>
                  </th>

                  <th class="th-right sortable-header" style="cursor:pointer;" (click)="sortData('cxpFollowUps')">
                    Sync with CXP
                    <span class="sort-arrows">
                      <span class="arrow-up"
                        [class.active]="sortColumn==='cxpFollowUps' && sortDirection==='asc'">▲</span>
                      <span class="arrow-down"
                        [class.active]="sortColumn==='cxpFollowUps' && sortDirection==='desc'">▼</span>
                    </span>
                  </th>

                  <th class="th-right sortable-header" style="cursor:pointer;" (click)="sortData('completedFollowUps')">
                    Completed
                    <span class="sort-arrows">
                      <span class="arrow-up"
                        [class.active]="sortColumn==='completedFollowUps' && sortDirection==='asc'">▲</span>
                      <span class="arrow-down"
                        [class.active]="sortColumn==='completedFollowUps' && sortDirection==='desc'">▼</span>
                    </span>
                  </th>

                  <th class="th-right sortable-header" style="cursor:pointer;" (click)="sortData('openFollowUps')">
                    Upcoming
                    <span class="sort-arrows">
                      <span class="arrow-up"
                        [class.active]="sortColumn==='openFollowUps' && sortDirection==='asc'">▲</span>
                      <span class="arrow-down"
                        [class.active]="sortColumn==='openFollowUps' && sortDirection==='desc'">▼</span>
                    </span>
                  </th>

                  <th class="th-right group-divider sortable-header" style="cursor:pointer;"
                    (click)="sortData('closedFollowUps')">
                    Overdue
                    <span class="sort-arrows">
                      <span class="arrow-up"
                        [class.active]="sortColumn==='closedFollowUps' && sortDirection==='asc'">▲</span>
                      <span class="arrow-down"
                        [class.active]="sortColumn==='closedFollowUps' && sortDirection==='desc'">▼</span>
                    </span>
                  </th>

                  <!-- Test Drives -->
                  <th class="th-right sortable-header" style="cursor:pointer;" (click)="sortData('saTestDrives')">
                    SA
                    <span class="sort-arrows">
                      <span class="arrow-up"
                        [class.active]="sortColumn==='saTestDrives' && sortDirection==='asc'">▲</span>
                      <span class="arrow-down"
                        [class.active]="sortColumn==='saTestDrives' && sortDirection==='desc'">▼</span>
                    </span>
                  </th>

                  <th class="th-right sortable-header" style="cursor:pointer;" (click)="sortData('cxpTestDrives')">
                    Sync with CXP
                    <span class="sort-arrows">
                      <span class="arrow-up"
                        [class.active]="sortColumn==='cxpTestDrives' && sortDirection==='asc'">▲</span>
                      <span class="arrow-down"
                        [class.active]="sortColumn==='cxpTestDrives' && sortDirection==='desc'">▼</span>
                    </span>
                  </th>

                  <th class="th-right sortable-header" style="cursor:pointer;"
                    (click)="sortData('completedTestDrives')">
                    Completed
                    <span class="sort-arrows">
                      <span class="arrow-up"
                        [class.active]="sortColumn==='completedTestDrives' && sortDirection==='asc'">▲</span>
                      <span class="arrow-down"
                        [class.active]="sortColumn==='completedTestDrives' && sortDirection==='desc'">▼</span>
                    </span>
                  </th>

                  <th class="th-right sortable-header" style="cursor:pointer;"
                    (click)="sortDataDealer('upcomingTestDrives')">
                    Upcoming
                    <span class="sort-arrows">
                      <span class="arrow-up"
                        [class.active]="sortColumn==='upcomingTestDrives' && sortDirection==='asc'">▲</span>
                      <span class="arrow-down"
                        [class.active]="sortColumn==='upcomingTestDrives' && sortDirection==='desc'">▼</span>
                    </span>
                  </th>

                  <th class="th-right group-divider sortable-header" style="cursor:pointer;"
                    (click)="sortDataDealer('closedTestDrives')">
                    Overdue
                    <span class="sort-arrows">
                      <span class="arrow-up"
                        [class.active]="sortColumn==='closedTestDrives' && sortDirection==='asc'">▲</span>
                      <span class="arrow-down"
                        [class.active]="sortColumn==='closedTestDrives' && sortDirection==='desc'">▼</span>
                    </span>
                  </th>

                  <th class="th-right sortable-header" style="cursor:pointer;"
                    (click)="sortDataDealer('opportunitiesConverted')">
                    Opportunities Converted
                    <span class="sort-arrows">
                      <span class="arrow-up"
                        [class.active]="sortColumn==='opportunitiesConverted' && sortDirection==='asc'">▲</span>
                      <span class="arrow-down"
                        [class.active]="sortColumn==='opportunitiesConverted' && sortDirection==='desc'">▼</span>
                    </span>
                  </th>

                </tr>
              </thead>

              <tbody>
                <ng-container
                  *ngFor="let dealer of getSortedDealersForSummary() | slice:0:table1Length; let i = index trackBy: trackByDealerId">
                  <!-- <ng-container
                  *ngFor="let dealer of (selectedDealers.length > 0 ? selectedDealers : dealers) | slice:0:table1Length; let i = index"> -->
                  <!-- <ng-container *ngFor="let dealer of selectedDealers | slice:0:table1Length; let i = index"> -->
                  <tr *ngIf="dealer" class="table-row">
                    <td class="sticky-col-header  td-left">
                      <!-- <button class="expand-btn" (click)="toggleRow($event, dealer, 'engagement-' + i)">
                        <span class="arrow">{{ expandedRow === 'engagement-' + i ? 'v' : '>' }}</span>
                        {{ dealer.dealerName }}
                      </button> -->
                      <button class="expand-btn" (click)="toggleRow($event, dealer, 'engagement-' + i)">
                        <i class="fa"
                          [ngClass]="expandedRow === 'engagement-' + i ? 'fa-chevron-down' : 'fa-chevron-right'"
                          style="font-size: 10px; margin-right: 5px; color: rgb(15 95 184 / var(--tw-text-opacity, 1));"></i>
                        <span style="color: rgb(15 95 184 / var(--tw-text-opacity, 1));">
                          {{ dealer.dealerName }}
                        </span>
                      </button>

                    </td>
                    <td class="td-right">{{ dealer.totalUsers ?? 0 }}</td>
                    <td class="td-right">{{ dealer.registerUsers ?? 0 }}</td>
                    <td class="td-right">{{dealer.activeUsers ?? 0}}</td>

                    <td class="td-right" style="color:#222fb9">{{ dealer.saLeads ?? 0 }}</td>
                    <td class="td-right" [ngStyle]="{'color': dealer.saLeads === dealer.cxpLeads ? 'green' : 'red'}">
                      {{ dealer.cxpLeads ?? 0 }}
                    </td>
                    <td class="td-right">{{ dealer.icsLeads ?? 0 }}</td>
                    <td class="td-right">{{ dealer.manuallyEnteredLeads ?? 0 }}</td>



                    <td class="td-right" style="color:#222fb9">{{ dealer.saFollowUps ?? 0 }}</td>
                    <!-- SA FOLLOWUPS -->
                    <td class="td-right"
                      [ngStyle]="{'color': dealer.saFollowUps === dealer.cxpFollowUps ? 'green' : 'red'}">
                      {{ dealer.cxpFollowUps ?? 0 }}
                    </td>

                    <td class="td-right">{{ dealer.completedFollowUps ?? 0 }}</td>
                    <!-- Compeplteted followups -->

                    <td class="td-right">{{ dealer.openFollowUps ?? 0 }}</td>
                    <td class="td-right">{{ dealer.closedFollowUps ?? 0 }}</td>
                    <!-- <td class="td-right">{{ dealer.cxpFollowUps ?? 0 }}</td> -->

                    <td class="td-right" style="color:#222fb9">{{ dealer.saTestDrives ?? 0 }}</td>
                    <td class="td-right"
                      [ngStyle]="{'color': dealer.saTestDrives === dealer.cxpTestDrives ? 'green' : 'red'}">
                      {{ dealer.cxpTestDrives ?? 0 }}
                    </td>
                    <td class="td-right">{{ dealer.completedTestDrives ?? 0 }}</td>
                    <td class="td-right">{{ dealer.upcomingTestDrives ?? 0 }}</td>
                    <!-- upcomingtestfrives -->
                    <td class="td-right">{{ dealer.closedTestDrives ?? 0 }}</td>
                    <!-- <td class="td-right">{{ dealer.uniqueTestDrives ?? 0 }}</td> -->
                    <!-- <td class="td-right">{{ dealer.cxpTestDrives ?? 0 }}</td> -->

                    <td class="td-right">{{ dealer.opportunitiesConverted ?? 0 }}</td>

                  </tr>

                  <!-- Sub Row -->
                  <tr *ngIf="expandedRow === 'engagement-' + i" class="sub-row">
                    <td colspan="20" class="sub-row-content">
                      <div class="sub-row-inner">
                        <div class="sub-row-title" style="text-align: left;">
                          User-wise details — {{ dealer.dealerName }}
                        </div>
                        <div class="sub-table-container">

                          <table class="sub-table">
                            <thead class="sub-table-thead" style="border-radius:20px !important">
                              <tr style="border-radius:20px !important">
                                <th style="text-align:left">User</th>


                                <th>Registered</th>
                                <th>Status</th>
                                <th>Last login</th>

                                <th>SA Leads</th>
                                <th>Sync with CXP</th>
                                <th>Sync with ICS</th>
                                <th>Manually Entered with CXP</th>

                                <th>SA Follow-ups</th>
                                <th>Sync with CXP</th>
                                <th>Completed</th>

                                <th>Upcoming</th>
                                <th>Overdue</th>
                                <!-- <th>Follow-ups (CXP)</th> -->


                                <th>SA Test Drives</th>
                                <th>Sync with CXP</th>

                                <th>Upcoming </th>
                                <th>Completed </th>
                                <th>Overdue</th>
                                <th>Opportunities Converted</th>
                              </tr>
                            </thead>
                            <tbody>
                              <!-- <tr *ngFor="let user of getSortedUsers(dealer.dealerId)"> -->
                              <!-- <tr *ngFor="let user of getSortedUsers(dealer.dealerId); let i = index"
                                [ngClass]="{'bg-alt': i % 2 === 1}" class="table-row-alt"> -->
                              <!-- <tr *ngFor="let user of getSortedUsers(dealer.dealerId); let i = index"
                                [ngClass]="{ 'row-alt': i % 2 === 0, 'row-normal': i % 2 !== 0 }"> -->
                              <tr
                                *ngFor="let user of getSortedUsers(dealer.dealerId); let i = index; trackBy: trackByUserId"
                                [ngClass]="{ 'row-alt': i % 2 === 0, 'row-normal': i % 2 !== 0 }">
                                <td style="text-align:left">
                                  {{ user.user }} <span *ngIf="user.user_role">({{ user.user_role }})</span>
                                </td>
                                <!-- <td class="td-rigth">{{user.registerUser ?? 0}}</td> -->
                                <td class="td-rigth">{{ user.registerUser ? 'Yes' : 'No' }}</td>

                                <td class="td-center">
                                  <span class="chip" [ngClass]="user.active ? 'chip-success' : 'chip-inactive'">
                                    {{ user.active ? 'Active' : 'Inactive' }}
                                  </span>
                                </td>
                                <td class="td-rigth">{{ user.last_login | date:'dd-MM-yyyy HH:mm' }}</td>



                                <td class="td-right">{{ user.leads?.sa ?? 0 }}</td>
                                <td class="td-right">{{ user.leads?.cxp ?? 0 }}</td>
                                <td class="td-right">{{ user.leads?.ics ?? 0 }}</td>
                                <td class="td-right">{{ user.leads?.manuallyEntered ?? 0 }}</td>


                                <td class="td-right">{{ user.followups?.sa ?? 0 }}</td>
                                <td class="td-right">{{ user.followups?.cxp ?? 0 }}</td>
                                <td class="td-right">{{ user.followups?.completed ?? 0 }}</td>
                                <td class="td-right">{{ user.followups?.open ?? 0 }}</td>
                                <td class="td-right">{{ user.followups?.closed ?? 0 }}</td>


                                <td class="td-right">{{ user.testdrives?.sa ?? 0 }}</td>
                                <td class="td-right">{{ user.testdrives?.cxp ?? 0 }}</td>

                                <!-- <td class="td-right">{{ user.testdrives?.unique ?? 0 }}</td> -->
                                <td class="td-right">{{ user.testdrives?.completed ?? 0 }}</td>
                                <td class="td-right">{{ user.testdrives?.upcoming ?? 0 }}</td>

                                <td class="td-right">{{ user.testdrives?.closed ?? 0 }}</td>

                                <td class="td-right">{{ user.opportunitiesConverted ?? 0 }}</td>

                              </tr>
                              <tr *ngIf="!dealerUsers[dealer.dealerId] || dealerUsers[dealer.dealerId]?.length === 0">
                                <td colspan="14" class="td-center">No Users Found</td>
                              </tr>
                            </tbody>
                          </table>
                        </div>
                      </div>
                    </td>
                  </tr>
                </ng-container>
              </tbody>
            </table>
          </div>
          <!-- Show More button -->
          <button type="button" style="margin: 0.5rem; float: right;" class="btn btn-primary" (click)="showMoreTable1()"
            *ngIf="table1Length < (selectedDealers.length > 0 ? selectedDealers.length : dealers.length)">
            Show More
          </button>
          <!-- Show Less button -->
          <button type="button" style="margin: 0.5rem; float: right;" class="btn btn-secondary"
            (click)="showLessTable1()"
            *ngIf="table1Length > 10 && (selectedDealers.length > 0 ? selectedDealers.length : dealers.length) > 10">
            Show Less
          </button>
        </div>
      </div>

      <!-- Table 2 -->
      <div class="table-section">
        <div class="table-header">
          <div>
            <h2 class="table-title" id="ds">Dealer Summary — Calls</h2>
            <p class="table-subtitle">Call volumes and outcomes</p>
          </div>
          <div class="table-actions">
            <div class="nav-button-group" style="margin-left:10px;">

              <button class="nav-button" [ngClass]="{ 'active': dealerSummaryCallsViewType === 'table' }"
                (click)="dealerEngagementView('table')">
                <i class="fas fa-table" style="margin-right: 6px; font-size:15px;"></i> Table
              </button>

              <button class="nav-button" [ngClass]="{ 'active': dealerSummaryCallsViewType === 'chart' }"
                (click)="dealerEngagementView('chart')">
                <i class="fas fa-chart-line" style="margin-right: 8px;"></i> Line Chart
              </button>
            </div>
            <button class="btn btn-small btn-secondary" (click)="exportDealerCalllogstocxp()">
              <i class="icon-download"></i> Export CSV
            </button>

          </div>
        </div>
        <!-- Table View -->
        <div *ngIf="dealerSummaryCallsViewType === 'table'" class="table-container">
          <div class="table-scroll">
            <table class="data-table calls-table">
              <thead class="table-thead">
                <tr>
                  <th class="sticky-col-header th-left" style="width:18%">Dealer</th>
                  <th class="th-right">Total Calls</th>
                  <th class="th-right">Outgoing</th>
                  <th class="th-right">Incoming</th>
                  <th class="th-right">Connected</th>
                  <th class="th-right">Declined</th>
                  <th class="th-right">Duration</th>
                </tr>
              </thead>
              <tbody>
                <!-- <ng-container *ngFor="let dealer of dealers | slice:0:table2Length; let i = index"> -->
                <!-- <ng-container
                  *ngFor="let dealer of (selectedDealers.length > 0 ? selectedDealers : dealers) | slice:0:table2Length; let i = index"> -->
                <ng-container
                  *ngFor="let dealer of getSortedDealersForCallLogs() | slice:0:table2Length; let i = index">
                  <!-- Main dealer row -->
                  <tr>
                    <td class="sticky-col td-font-medium">
                      <!-- <button class="expand-btn" (click)="toggleRow($event, dealer, 'engagement-' + i)">
                        <span class="arrow">{{ expandedRow === 'engagement-' + i ? 'v' : '>' }}</span>
                        {{ dealer.dealerName }}
                      </button> -->
                      <button class="expand-btn" (click)="toggleRow($event, dealer, 'engagement-' + i)">
                        <i class="fa"
                          [ngClass]="expandedRow === 'engagement-' + i ? 'fa-chevron-down' : 'fa-chevron-right'"
                          style="font-size: 10px; margin-right: 5px; color: rgb(15 95 184 / var(--tw-text-opacity, 1));"></i>
                        <span style="color: rgb(15 95 184 / var(--tw-text-opacity, 1));">
                          {{ dealer.dealerName }}
                        </span>
                      </button>
                    </td>
                    <!-- <td [ngClass]="dealer.callLogs?.totalCalls < 60 ? 'highlight-red' : 'normal'">
                      <div style="display: flex; align-items: center; justify-content: center !important;">
                        <i class="fa fa-phone" style="margin-right: 8px;"></i>
                        <span>{{ dealer.callLogs?.totalCalls || 0 }}</span>
                      </div>
                    </td> -->
                    <td>
                      <div [ngClass]="dealer.callLogs?.totalCalls < 60 ? 'highlight-red' : 'normal'"
                        style="display: flex; align-items: center; justify-content: center !important;">
                        <i class="fa fa-phone" [ngClass]="dealer.callLogs?.totalCalls < 60 ? 'highlight-red' : 'normal'"
                          style="margin-right: 8px;"></i>
                        <span [ngClass]="dealer.callLogs?.totalCalls < 60 ? 'highlight-red' : 'normal'"
                          style="margin-left: 4px; display: inline-block; width: 36px; text-align: left; font-size: 12px;">
                          {{ dealer.callLogs?.totalCalls || 0 }}
                        </span>
                      </div>
                    </td>

                    <!-- <td>
                      <div style="display: flex; align-items: center; justify-content: center !important;">
                        <span style="color: green; font-size: 18px; margin-right: 8px;">&#8593;</span> 
                        <span style="color: green;">{{ dealer.callLogs?.outgoing || 0 }}</span>
                      </div>
                    </td> -->

                    <td>
                      <div style="display: flex; align-items: center; justify-content: center !important;">
                        <span style="color: green; font-size: 18px; margin-right: 8px;">&#8593;</span> <!-- ↑ -->
                        <span
                          style="color: green; margin-left: 4px; display: inline-block; width: 36px; text-align: left; font-size: 12px;">
                          {{ dealer.callLogs?.outgoing || 0 }}
                        </span>
                      </div>
                    </td>
                    <td>
                      <div style="display: flex; align-items: center; justify-content: center !important;">
                        <!-- Green arrow -->
                        <span style="color: green; font-size: 18px; margin-right: 8px;">
                          &#8595;
                        </span>

                        <!-- Incoming number -->
                        <span
                          style="color: green; margin-left: 4px; display: inline-block; width: 36px; text-align: left; font-size: 13px;">
                          {{ dealer.callLogs?.incoming || 0 }}
                        </span>
                      </div>
                    </td>


                    <!-- Connected Call -->
                    <!-- <td>
                      <div style="display: flex; align-items: center; justify-content: center !important;">
                        <span [ngStyle]="{
                                        display: 'inline-flex',
                                        justifyContent: 'center',
                                        alignItems: 'center',
                                        width: '16px',
                                        height: '16px',
                                        borderRadius: '50%',
                                        backgroundColor: dealer.callLogs?.connected < 30 ? 'red' : '#007bff',
                                        color: 'white',
                                        fontSize: '10px',
                                        marginRight: '8px'
                                      }">
                          &#10003;
                        </span>
                        <span [ngStyle]="{ color: dealer.callLogs?.connected < 30 ? 'red' : '#007bff' }">
                          {{ dealer.callLogs?.connected || 0 }}
                        </span>
                      </div>
                    </td> -->
                    <td>
                      <div style="display: flex; align-items: center; justify-content: center !important;">
                        <!-- Circle icon -->
                        <span [ngStyle]="{
                            display: 'inline-flex',
                            justifyContent: 'center',
                            alignItems: 'center',
                            width: '16px',
                            height: '16px',
                            borderRadius: '50%',
                            backgroundColor: dealer.callLogs?.connected < 30 ? 'red' : '#007bff',
                            color: 'white',
                            fontSize: '10px',
                            flexShrink: 0,
                            marginRight: '8px'  
                          }">
                          &#10003;
                        </span>

                        <!-- Connected calls count -->
                        <span [ngStyle]="{
                            color: dealer.callLogs?.connected < 30 ? 'red' : '#007bff',
                            marginLeft: '4px',
                            display: 'inline-block',
                            width: '36px',
                            textAlign: 'left',
                            fontSize: '12px'
                          }">
                          {{ dealer.callLogs?.connected || 0 }}
                        </span>
                      </div>
                    </td>


                    <!-- Declined Call -->
                    <!-- <td>
                      <div style="display: flex; align-items: center; justify-content: center !important;">
                        <span style="
                                      display: inline-flex;
                                      justify-content: center;
                                      align-items: center;
                                      width: 16px;
                                      height: 16px;
                                      border-radius: 50%;
                                      background-color: red;
                                      color: white;
                                      font-size: 10px;
                                      margin-right: 8px;
                                    ">
                          &times;
                        </span>
                        <span style="color: red;">{{ dealer.callLogs?.declined || 0 }}</span>
                      </div>
                    </td> -->
                    <td>
                      <div style="display: flex; align-items: center; justify-content: center !important;">
                        <!-- Circle icon -->
                        <span style="
        display: inline-flex;
        justify-content: center;
        align-items: center;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background-color: red;
        color: white;
        font-size: 10px;
        flex-shrink: 0;
        margin-right: 8px;
      ">
                          &times;
                        </span>

                        <!-- Declined calls count -->
                        <span style="
        color: red;
        margin-left: 4px;
        display: inline-block;
        width: 36px;
        text-align: left;
        font-size: 12px;
      ">
                          {{ dealer.callLogs?.declined || 0 }}
                        </span>
                      </div>
                    </td>



                    <!-- Duration -->
                    <td>
                      {{ dealer.callLogs?.durationSec ? formatDuration(dealer.callLogs.durationSec) : '00:00:00' }}
                    </td>
                  </tr>

                  <!-- Sub-row: user call logs -->
                  <!-- Sub-row: User call logs -->
                  <tr *ngIf="expandedRow === 'engagement-' + i" class="sub-row">
                    <td colspan="10" class="sub-row-content" style="padding: 0;">
                      <div class="sub-row-inner" style="padding-left: 13px !important;">
                        <div class="sub-row-title"
                          style="text-align: left !important; font-weight: 600; padding: 4px 8px;">
                          User-wise Call Logs — {{ dealer.dealerName }}
                        </div>
                        <div class="sub-table-container">
                          <table class="sub-table">
                            <thead>
                              <tr>
                                <th style="text-align: left !important;">User</th>
                                <th>Total</th>
                                <th>Outgoing</th>
                                <th>Incoming</th>
                                <th>Connected</th>
                                <th>Declined</th>
                                <th>Duration</th>
                              </tr>
                            </thead>
                            <tbody>


                              <tr
                                *ngFor="let user of getSortedCallLogs(dealer.dealerId); let i = index; trackBy: trackByUserId">
                                <td style="text-align: left !important;width:90px !important">{{ user.name }}</td>
                                <td [ngStyle]="{ color: user.calls.total < 60 ? 'red' : 'black' }">{{ user.calls.total
                                  }}</td>
                                <td style="color:green">{{ user.calls.outgoing }}</td>
                                <td style="color:green"> {{ user.calls.incoming }}</td>
                                <td [ngStyle]="{ color: user.calls.connected < 30 ? 'red' : '#007bff' }">{{
                                  user.calls.connected }}</td>
                                <td style="color:red;">{{ user.calls.declined }}</td>
                                <!-- <pre>{{ user| json }}</pre> -->

                                <td style="color:black;">
                                  {{ user.calls.duration}}
                                </td>
                              </tr>
                              <tr *ngIf="!userCallLogs[dealer.dealerId] || userCallLogs[dealer.dealerId]?.length === 0">
                                <td colspan="7" class="td-center">No Users Found</td>
                              </tr>
                            </tbody>
                          </table>
                        </div>
                      </div>
                    </td>
                  </tr>


                </ng-container>
              </tbody>
            </table>
            <!-- Show More / Show Less buttons -->

          </div>
          <div style="display:flex; justify-content:flex-end; gap:0.5rem; margin-top:0.5rem;">
            <button type="button" class="btn btn-primary" (click)="showMoreTable2()"
              *ngIf="table2Length < dealers.length">
              Show More
            </button>
            <button type="button" class="btn btn-secondary" (click)="showLessTable2()"
              *ngIf="table2Length > 10 && dealers.length > 10">
              Show Less
            </button>
          </div>
        </div>
        <!-- Chart View -->
        <div *ngIf="dealerSummaryCallsViewType === 'chart'" class="chart-container"
          style="min-height:400px; padding:20px; background:white; border-radius:10px;">
          <div id="chart">
            <apx-chart [series]="chartOptions.series!" [chart]="chartOptions.chart!" [xaxis]="chartOptions.xaxis!"
              [stroke]="chartOptions.stroke!" [dataLabels]="chartOptions.dataLabels!" [title]="chartOptions.title!">
            </apx-chart>
          </div>
        </div>
      </div>
    </main>
  </div>
</ng-container>
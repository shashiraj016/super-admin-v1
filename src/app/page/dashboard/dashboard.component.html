<div class="dashboard-container">
  <div class="orders-table-container">

    <!-- Filter buttons + Custom date inline -->
    <!-- Filter buttons + Custom date inline -->
    <!-- Filter buttons + Custom date inline -->
      <div class="filter-container mb-3 d-flex align-items-center">
        <!-- Standard Filters -->
        <button class="btn filter-btn me-2" [ngClass]="{'active': selectedFilter==='MTD'}"
          (click)="onFilterChange('MTD')">MTD</button>
        <button class="btn filter-btn me-2" [ngClass]="{'active': selectedFilter==='QTD'}"
          (click)="onFilterChange('QTD')">QTD</button>
        <button class="btn filter-btn me-3" [ngClass]="{'active': selectedFilter==='YTD'}"
          (click)="onFilterChange('YTD')">YTD</button>

        <!-- Custom Date Filter inline -->
        <label class="me-2 mb-0" style="margin-left:10px;">Custom date:</label>
        <input type="date" [(ngModel)]="customStartDate" class="form-control form-control-sm me-2"
          style="width: 120px; display: inline-block; margin-left:10px;" />
        <input type="date" [(ngModel)]="customEndDate" class="form-control form-control-sm me-2"
          style="width: 120px; display: inline-block; margin-left:10px;" />
        <button class="btn btn-sm " style="margin-left:10px;" (click)="applyCustomDateFilter()">Apply</button>
          <button class="btn btn-sm " style="margin-left:10px;" (click)="clearCustomDateFilter()">Clear</button>

          <span *ngIf="appliedStartDate && appliedEndDate" class="ms-3 fw-bold text-primary">
            Showing data from {{ appliedStartDate | date:'shortDate' }} to {{ appliedEndDate | date:'shortDate' }}
          </span>
      </div>

    <!-- Table -->
    <div class="table-responsive" *ngIf="paginatedDealers.length > 0">
      <table class="table table-bordered table-striped">
        <thead>
          <tr>
            <th>Dealer name</th>
            <th>Enquiries</th>
            <th>Test Drives</th>
            <th>Orders</th>
            <th>Net orders</th>
            <th>Lost leads</th>
            <th>Retail</th>
            <th>Cancellations</th>
            <th>Upcoming Followups</th>
            <th>Overdue Followups</th>
            <th>Outgoing</th>
            <th>Incoming</th>
            <th>Connected</th>
            <th>Declined</th>
            <th>Duration</th>
            <th>Total user</th>
            <th>Active user</th>
            <th></th>
          </tr>
        </thead>

        <tbody>
          <ng-container *ngFor="let dealer of paginatedDealers; let i = index trackBy: trackByDealerId" >
            <!-- Dealer row -->
            <tr>
              <td>{{ dealer.dealer_name }}</td>
              <td>{{ dealer.enquiries }}</td>
              <td>{{ dealer.testDrives }}</td>
              <td>{{ dealer.orders }}</td>
              <td>{{ dealer.net_orders }}</td>
              <td>{{ dealer.lostEnquiries }}</td>
              <td>{{ dealer.retail }}</td>
              <td>{{ dealer.cancellations }}</td>
              <td>{{ dealer.upComingFollowups }}</td>
              <td>{{ dealer.overdueFollowups }}</td>
              <td>{{ dealer.callLogs?.outgoing }}</td>
              <td>{{ dealer.callLogs?.incoming }}</td>
              <td>{{ dealer.callLogs?.connected }}</td>
              <td>{{ dealer.callLogs?.declined }}</td>
              <td>{{ dealer.callLogs?.duration || '-' }}</td>
              <td>{{ dealer.totalUsersCount }}</td>
              <td>{{ dealer.activeUsersCount }}</td>
              <td>
                <button class="icon-btn" (click)="toggleDetails(i, dealer)">
                  <i class="fas" [ngClass]="expandedRow === i ? 'fa-minus' : 'fa-plus'"></i>
                </button>
              </td>
            </tr>

            <!-- User rows under dealer -->
            <!-- User rows under dealer -->
            <ng-container *ngIf="expandedRow === i">
              <!-- Label row for users -->
            <!-- <tr class="table-secondary">
              <td colspan="18" class="fw-bold ps-3">
                Users for {{ dealer.dealer_name }}
              </td>
            </tr> -->
<tr *ngIf="(dealerUsers[dealer.dealer_id] || []).length > 0" class="table-secondary">
  <td colspan="18" class="fw-bold ps-3">
    Users for {{ dealer.dealer_name }}
  </td>
</tr>


              <!-- Actual user rows -->
              <tr *ngFor="let user of dealerUsers[dealer.dealer_id]"  >
                <td class="ps-4" style="color:#222fb9 !important" >{{ user.user_name }}</td>
                <td style="color:#222fb9 !important">{{ user.enquiries }}</td>
                <td style="color:#222fb9 !important">{{ user.testDrives }}</td>
                <td style="color:#222fb9 !important">{{ user.orders }}</td>
                <td style="color:#222fb9 !important">{{ user.net_orders }}</td>
                <td style="color:#222fb9 !important">{{ user.lostEnquiries }}</td>
                <td style="color:#222fb9 !important">{{ user.retail }}</td>
                <td style="color:#222fb9 !important">{{ user.cancellations }}</td>
                <td style="color:#222fb9 !important">{{ user.upComingFollowups }}</td>
                <td style="color:#222fb9 !important">{{ user.overdueFollowups }}</td>
                <td style="color:#222fb9 !important">{{ user.callLogs?.outgoing }}</td>
                <td style="color:#222fb9 !important">{{ user.callLogs?.incoming }}</td>
                <td style="color:#222fb9 !important">{{ user.callLogs?.connected }}</td>
                <td style="color:#222fb9 !important">{{ user.callLogs?.declined }}</td>
                <td style="color:#222fb9 !important">{{ user.callLogs?.duration || '-' }}</td>
                <td>-</td>
                <td>-</td>
                <td></td>
              </tr>

              <!-- If no users (only show after API response) -->
              <!-- <tr *ngIf="dealerUsers[dealer.dealer_id] && dealerUsers[dealer.dealer_id].length === 0">
                <td colspan="18" class="text-center text-muted">No users found for this dealer.</td>
              </tr> -->
              <tr *ngIf="dealerUsers[dealer.dealer_id] && dealerUsers[dealer.dealer_id].length === 0">
                <td colspan="18" class="text-center text-muted">
                  No users found for {{ dealer.dealer_name }}.
                </td>
              </tr>

            </ng-container>

          </ng-container>



        </tbody>
      </table>

      <!-- Pagination -->
      <div class="pagination-container mt-2 d-flex justify-content-end align-items-center">
        <button class="btn btn-sm me-2" (click)="onPageChange(currentPage - 1)"
          [disabled]="currentPage === 1">Prev</button>
        <span class="me-2">Page {{ currentPage }} of {{ Math.ceil(dealers.length / itemsPerPage) || 1 }}</span>
        <button class="btn btn-sm" (click)="onPageChange(currentPage + 1)"
          [disabled]="currentPage === (Math.ceil(dealers.length / itemsPerPage) || 1)">Next</button>
      </div>

      <div *ngIf="paginatedDealers.length === 0" class="text-center mt-3">
        No dealers found.
      </div>


    </div>
  </div>
<!-- Main Dashboard Content -->
<ng-container *ngIf="!selectedDealer && !selectedSM">
  <div class="dashboard-container">
    <!-- Tab Navigation Header -->
    <!-- <div class="header2" [ngClass]="{ 'sidebar-open': isSidebarOpen, 'sidebar-closed': !isSidebarOpen }">
      <div class="nav-button-group" style="margin-left:10px;">
        <button class="nav-button" [ngClass]="{ 'active': selectedSection === 'home' }" (click)="selectSection('home')">
          <i class="fas fa-home" style="margin-right: 6px;font-size:15px;"></i> Home
        </button>

        <button class="nav-button" [ngClass]="{ 'active': selectedSection === 'analysis' }"
          (click)="selectSection('analysis')">
          <i class="fas fa-chart-line" style="margin-right: 8px;"></i> Analysis
        </button>
      </div>
    </div> -->
    <div class="header2" [ngClass]="{ 'sidebar-open': isSidebarOpen, 'sidebar-closed': !isSidebarOpen }">
      <div class="nav-button-group" style="margin-left:10px;">

        <!-- Analysis button (was Home) -->
        <button class="nav-button" [ngClass]="{ 'active': selectedSection === 'analysis' }"
          (click)="selectSection('analysis')">
          <i class="fas fa-chart-line" style="margin-right: 6px; font-size:15px;"></i> Analysis
        </button>

        <!-- Call Analysis button (was Analysis) -->
        <button class="nav-button" [ngClass]="{ 'active': selectedSection === 'callAnalysis' }"
          (click)="selectSection('callAnalysis')">
          <i class="fas fa-phone-alt" style="margin-right: 8px;"></i> Call Analysis
        </button>

      </div>
    </div>


    <!-- HOME TAB CONTENT -->
    <div *ngIf="selectedSection === 'analysis'" class="content-section active">

      <div style="
          background-color: white;
          display: inline-flex;
          gap: 6px;
          color: #000;
          padding: 6px 12px;
          border-radius: 999px;
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
          font-family: 'Poppins', sans-serif;
          margin-top: -150px !important;   /* positive margin to separate from tabs */
          margin-bottom: 20px; /* space below pills before cards */
          width: max-content;  /* so the pill container fits contents */
        ">
          <!-- <button *ngFor="let option of ['MTD', 'QTD', 'YTD']" (click)="onFilterChange(option)"
            [ngClass]="{ 'pill-active': selectedFilter === option }" class="pill-button">
            {{ option }}
          </button> -->
          <button *ngFor="let option of filterOptions" (click)="onFilterChange(option)"
            [ngClass]="{ 'pill-active': selectedFilter === option }" class="pill-button">
            {{ option }}
          </button>

      </div>

      <!-- Metrics Section -->
      <div class="dashboard-container">
        <!-- <div class="metrics-row" style="display: flex; gap: 15px; font-family: 'Poppins', sans-serif;">

          <div class="metric-box" style="border: 1px solid #E4E4E7; border-radius: 10px; overflow: hidden;">
            <div class="metric-value" style="color:black;font-size:1.125rem;font-weight:500;">{{
              dashboardMetrics.totalLeads }}</div>
            <div class="metric-label"
              style="color:#000;font-size:18px;font-weight:400;font-family: 'Poppins', sans-serif">Enquiries</div>
          </div>

          <div class="metric-box" style="border: 1px solid #E4E4E7; border-radius: 10px; overflow: hidden;">
            <div class="metric-value" style="color:black;font-size:1.125rem;font-weight:500;">{{
              dashboardMetrics.totalTestDrives }}</div>
            <div class="metric-label"
              style="color:#000;font-size:18px;font-weight:400;font-family: 'Poppins', sans-serif">Test Drives</div>
          </div>

          <div class="metric-box" style="border: 1px solid #E4E4E7; border-radius: 10px; overflow: hidden;">
            <div class="metric-value" style="color:black;font-size:1.125rem;font-weight:500;">{{
              dashboardMetrics.totalOrders }}</div>
            <div class="metric-label"
              style="color:#000;font-size:18px;font-weight:400;font-family: 'Poppins', sans-serif"> Orders</div>
          </div>

          <div class="metric-box" style="border: 1px solid #E4E4E7; border-radius: 10px; overflow: hidden;">
            <div class="metric-value" style="color:black;font-size:1.125rem;font-weight:500;">{{
              dashboardMetrics.lostLeads }}</div>
            <div class="metric-label"
              style="color:#000;font-size:18px;font-weight:400;font-family: 'Poppins', sans-serif"> Lost leads</div>
          </div>

          <div class="metric-box" style="border: 1px solid #E4E4E7; border-radius: 10px; overflow: hidden;">
            <div class="metric-value" style="color:black;font-size:1.125rem;font-weight:500;">{{
              dashboardMetrics.cancellations }}</div>
            <div class="metric-label"
              style="color:#000;font-size:18px;font-weight:400;font-family: 'Poppins', sans-serif">Cancellation</div>
          </div>

          <div class="metric-box" style="border: 1px solid #E4E4E7; border-radius: 10px; overflow: hidden;">
            <div class="metric-value" style="color:black;font-size:1.125rem;font-weight:500;">{{
              dashboardMetrics.netOrders }}</div>
            <div class="metric-label"
              style="color:#000;font-size:18px;font-weight:400;font-family: 'Poppins', sans-serif;">Net Orders</div>
          </div>

          <div class="metric-box" style="border: 1px solid #E4E4E7; border-radius: 10px; overflow: hidden;">
            <div class="metric-value" style="color:black;font-size:1.125rem;font-weight:500;">{{ dashboardMetrics.retail
              }}</div>
            <div class="metric-label"
              style="color:#000;font-size:18px;font-weight:400;font-family: 'Poppins', sans-serif">Retail</div>
          </div>
        </div> -->
      </div>

      <!-- Dealers List -->
<!-- Dealers List -->
  <div class="dashboard-container" style="background-color:transparent !important">
    <div class="accordion level-1">

      <!-- Loop starts -->
      <!-- <div *ngFor="let dealer of dealers; let i = index" class="dealer-block"
        [style.backgroundColor]="dealerColors[i % dealerColors.length]"> -->
<div *ngFor="let dealer of paginatedDealerskpi; let i = index" class="dealer-block"
        [style.backgroundColor]="dealerColors[i % dealerColors.length]"> 

        <!-- Dealer header -->
      <div class="accordion-header" (click)="toggleDealerSMs(dealer.dealer_id)">
        <span>
          <span class="level-indicator">DEALER</span>
          {{ dealer.dealer_name }}
        </span>
        <button class="accordion-toggle">
          {{ selectedDealerId === dealer.dealer_id ? '‚ñ≤' : '‚ñº' }}
        </button>
      </div>

        <!-- Dealer KPIs -->
  <div class="accordion-content" [ngClass]="{ 'active': selectedDealerId === dealer.dealer_id }">
          <div class="content-wrapper">
            <div class="kpi-grid">
              <div class="kpi-card">
                <div class="kpi-value">{{ dealer.enquiries }}</div>
                <div class="kpi-label">Enquiries</div>
              </div>
              <div class="kpi-card">
                <div class="kpi-value">{{ dealer.testDrives }}</div>
                <div class="kpi-label">Test Drives</div>
              </div>
              <!-- <div class="kpi-card">
                <div class="kpi-value">{{ dealer.lostLeads }}</div>
                <div class="kpi-label">Lost Leads</div>
              </div> -->
              <div class="kpi-card">
                <div class="kpi-value">{{ dealer.orders }}</div>
                <div class="kpi-label">Orders</div>
              </div>
              <div class="kpi-card">
                <div class="kpi-value">{{ dealer.cancellations }}</div>
                <div class="kpi-label">Cancellations</div>
              </div>
              <div class="kpi-card">
                <div class="kpi-value">{{ dealer.net_orders }}</div>
                <div class="kpi-label">Net Orders</div>
              </div>
              <div class="kpi-card">
                <div class="kpi-value">{{ dealer.retail }}</div>
                <div class="kpi-label">Retail</div>
              </div>
            </div>
          </div>


          <!-- üîΩ SM Loop under Dealer -->
    <!-- üîΩ SM Loop under Dealer -->
<!-- SM Loop under Dealer -->
<div class="accordion level-2" *ngFor="let sm of dealerSMS[dealer.dealer_id]">
  <div class="accordion-header" (click)="toggleSM(sm.sm_id, dealer.dealer_id)">
    <span>
      <span class="level-indicator">SM</span>
      {{ sm.sm_name }}
    </span>
    <button class="accordion-toggle">
      {{ activeSM === sm.sm_id ? '‚ñ≤' : '‚ñº' }}
    </button>
  </div>

  <!-- SM KPIs AND PS sections should be inside the SAME accordion-content -->
  <div class="accordion-content" [ngClass]="{ 'active': activeSM === sm.sm_id }">
    <div class="content-wrapper">
      <!-- SM KPI Grid -->
      <div class="kpi-grid">
        <div class="kpi-card">
          <div class="kpi-value">{{ sm.enquiries }}</div>
          <div class="kpi-label">Enquiries</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-value">{{ sm.testDrives }}</div>
          <div class="kpi-label">Test Drives</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-value">{{ sm.orders }}</div>
          <div class="kpi-label">Orders</div>
        </div>
      </div>

      <!-- ‚úÖ PS Loop should be INSIDE the SM's accordion content -->
      <div class="accordion level-3" *ngFor="let ps of psData[sm.sm_id]">
        <div class="accordion-header" (click)="togglePS(ps.ps_id)">
          <span>
            <span class="level-indicator">PS</span>
            {{ ps.ps_name }}
          </span>
          <button class="accordion-toggle">
            {{ activePS === ps.ps_id ? '‚ñ≤' : '‚ñº' }}
          </button>
        </div>
        <!-- <div class="accordion level-3" *ngFor="let ps of psData[sm.sm_id]">
          <div class="accordion-header" (click)="togglePS(ps.ps_id)">
            <span>
              <span class="level-indicator">PS</span>
              {{ ps.ps_fname }} {{ ps.ps_lname }}
            </span>
            <button class="accordion-toggle">
              {{ activePS === ps.ps_id ? '‚ñ≤' : '‚ñº' }}
            </button>
          </div> -->

        <div class="accordion-content" [ngClass]="{ 'active': activePS === ps.ps_id }">
          <div class="content-wrapper">
            <div class="kpi-grid">
              <div class="kpi-card">
                <div class="kpi-value">{{ ps.enquiries }}</div>
                <div class="kpi-label">Enquiries</div>
              </div>
              <div class="kpi-card">
                <div class="kpi-value">{{ ps.testDrives }}</div>
                <div class="kpi-label">Test Drives</div>
              </div>
              <div class="kpi-card">
                <div class="kpi-value">{{ ps.orders }}</div>
                <div class="kpi-label">Orders</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- End PS Loop -->

    </div>
  </div>
</div>
  

    

      
  </div>
      </div>
    </div>
    <!-- <div class="pagination-controls" style="margin-top: 20px; text-align:center;">
      <button (click)="prevPage()" [disabled]="currentPage === 1">Prev</button>
      <span>Page {{ currentPage }} of {{ totalPagesdealer }}</span>
      <button (click)="nextPage()" [disabled]="currentPage === totalPagesdealer">Next</button>
    </div>
  </div> -->
<div class="pagination-wrapper" style="background-color: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.1); 
            padding: 15px 20px; border-radius: 10px; display: flex; 
            justify-content: space-between; align-items: center; margin-top: 20px;">

  <!-- Left side: showing entries -->
  <div class="entries-info" style="font-size: 14px; color: #333;">
    Showing {{ startEntry }} to {{ endEntry }} of {{ dealers.length }} entries
  </div>

  <!-- Right side: pagination buttons -->
  <div class="pagination-buttons" style="display: flex; gap: 10px; align-items: center;">
    <button (click)="prevPage()" [disabled]="currentPage === 1"
      style="padding: 6px 12px; border: none; background-color: #222fb9; color: #fff; border-radius: 5px; cursor: pointer;"
      [ngStyle]="{'opacity': currentPage === 1 ? 0.5 : 1}">
      Prev
    </button>

    <span style="font-size: 14px; color: #333;">Page {{ currentPage }} of {{ totalPagesdealer }}</span>

    <button (click)="nextPage()" [disabled]="currentPage === totalPagesdealer"
      style="padding: 6px 12px; border: none; background-color: #222fb9; color: #fff; border-radius: 5px; cursor: pointer;"
      [ngStyle]="{'opacity': currentPage === totalPagesdealer ? 0.5 : 1}">
      Next
    </button>
  </div>

</div>


    </div>


    </div>
      </div>

    

  <!-- ANALYSIS TAB CONTENT -->
  <div *ngIf="selectedSection === 'callAnalysis'" class="dashboard-content content-section active">
    <!-- Analysis content will go here -->
    <div class="dashboard-container" style="margin-top:60px;">
      <div class="metrics-row" style="display: flex; gap: 15px; margin-top: -45px;font-family: 'Poppins', sans-serif;">

        <div class="metric-box" style="border: 1px solid #E4E4E7; border-radius: 10px; overflow: hidden;">
          <div class="metric-value" style="color:black;font-size:1.125rem;font-weight:500;">{{
            dashboardMetrics.totalLeads
            }}
          </div>
          <div class="metric-label"
            style="color:#000;font-size:18px;font-weight:400;font-family: 'Poppins', sans-serif">Enquiries</div>
        </div>
        <div class="metric-box" style="border: 1px solid #E4E4E7; border-radius: 10px; overflow: hidden;">
          <div class="metric-value" style="color:black;font-size:1.125rem;font-weight:500;">{{
            dashboardMetrics.totalTestDrives
            }}
          </div>
          <div class="metric-label"
            style="color:#000;font-size:18px;font-weight:400;font-family: 'Poppins', sans-serif">Test Drives</div>
        </div>
        <div class="metric-box" style="border: 1px solid #E4E4E7; border-radius: 10px; overflow: hidden;">
          <div class="metric-value" style="color:black;font-size:1.125rem;font-weight:500;;">{{
            dashboardMetrics.totalOrders
            }}
          </div>
          <div class="metric-label"
            style="color:#000;font-size:18px;font-weight:400;font-family: 'Poppins', sans-serif">Orders</div>
        </div>
        <div class="metric-box" style="border: 1px solid #E4E4E7; border-radius: 10px; overflow: hidden;">
          <div class="metric-value" style="color:black;font-size:1.125rem;font-weight:500;;">{{
            dashboardMetrics.cancellations
            }}</div>
          <div class="metric-label"
            style="color:#000;font-size:18px;font-weight:400;font-family: 'Poppins', sans-serif">Cancellation</div>
        </div>
        <div class="metric-box" style="border: 1px solid #E4E4E7; border-radius: 10px; overflow: hidden;">
          <div class="metric-value" style="color:black;font-size:1.125rem;font-weight:500;">{{
            dashboardMetrics.netOrders
            }}
          </div>
          <div class="metric-label"
            style="color:#000;font-size:18px;font-weight:400;font-family: 'Poppins', sans-serif;">Net Order</div>
        </div>
        <div class="metric-box" style="border: 1px solid #E4E4E7; border-radius: 10px; overflow: hidden;">
          <div class="metric-value" style="color:black;font-size:1.125rem;font-weight:500;">{{ dashboardMetrics.retail
            }}
          </div>
          <div class="metric-label"
            style="color:#000;font-size:18px;font-weight:400;font-family: 'Poppins', sans-serif">Retail</div>
        </div>

        <!-- Last box with filters inside -->
        <div class="metric-box"
          style="display: flex; flex-direction: column; align-items: center; width: 500px; box-sizing: border-box; padding: 10px;border: 1px solid #ccc; border-radius: 10px; overflow: hidden;">
          <!-- Filters inside last box -->
          <div class="filters-title" style="margin-bottom: 8px;color:black;font-size:18px;font-weight:400;">Filters
          </div>
          <div class="time-filters" style="display: flex; gap: 6px; flex-wrap: wrap; justify-content: center;">

            <button class="filter-button" style="padding: 4px 8px; font-size: 0.8rem;"
              [class.active]="activeFilter === 'MTD'" (click)="onFilterClick('MTD')">
              MTD
            </button>
            <button class="filter-button" style="padding: 4px 8px; font-size: 0.8rem;"
              [class.active]="activeFilter === 'QTD'" (click)="onFilterClick('QTD')">
              QTD
            </button>
            <button class="filter-button" style="padding: 4px 8px; font-size: 0.8rem;"
              [class.active]="activeFilter === 'YTD'" (click)="onFilterClick('YTD')">
              YTD
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Performance panels for analysis -->
    <div class="performance-panels" style="width: 100%; display: flex; flex-direction: column; gap: 20px;">

      <!-- Add your analysis-specific content here -->
      <div class="performance-panel">
        <h2 class="panel-title">
          Super Admin Analysis
          <br>
          <p style="background:none">Performance analysis across all dealers</p>
        </h2>

        <!-- Add your analysis tables, charts, or other content here -->
        <div style="padding: 20px; text-align: center; color: #666;">
          Analysis content will be added here...
        </div>
      </div>

    </div>
  </div>
</ng-container>

<!-- PS1 & PS2 Cards Section (only shown when SM is selected) -->
<div class="ps-cards-page" *ngIf="selectedSM" style="margin-top: 40px;">
  <button class="back-arrow" (click)="goBack()" title="Go Back">‚Üê</button>
  <h2 style="margin: 16px 0;">{{ selectedSM.sm_name }}</h2>

  <div class="ps-section" style="display: flex; gap: 40px; flex-wrap: wrap;">

    <!-- Show PS cards if data exists -->
    <ng-container *ngIf="paginatedPs1Data.length > 0; else noPSData">
      <h3 style="font-weight: 600; margin-bottom: 16px;"></h3>
      <div style="display: flex; gap: 20px; flex-wrap: wrap;">
        <div *ngFor="let item of paginatedPs1Data; let i = index" (mouseenter)="hoveredPS = item.ps_id"
          (mouseleave)="hoveredPS = null" (click)="onPSCardClick(item.ps_id)"
          style="background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.06); padding: 16px; width: 120px; text-align: center; cursor: pointer; position: relative;">

          <!-- Avatar -->
          <div [ngStyle]="getAvatarStyle(i)">
            {{ item.ps_name.charAt(0).toUpperCase() }}
          </div>

          <!-- Name -->
          <div
            style="font-size: 12px; font-weight: 600; color: #2c2c2c; margin-top: 8px; font-family: 'Poppins', sans-serif;">
            {{ item.ps_name }}
          </div>

          <!-- Tooltip -->
          <div *ngIf="hoveredPS === item.ps_id"
            style="position: absolute; top: 90%; left: 50%; transform: translateX(-50%); background: #f0f0ff; border: 1px solid #ccc; padding: 8px 12px; border-radius: 8px; font-size: 12px; color: #333; white-space: nowrap; box-shadow: 0 2px 6px rgba(0,0,0,0.1); z-index: 10; text-align: left; line-height: 1.6;">
            <div><strong>Enquiries:</strong> {{ item.enquiries }}</div>
            <div><strong>Test Drives:</strong> {{ item.testDrives }}</div>
            <div><strong>Orders:</strong> {{ item.orders }}</div>
            <div><strong>Cancellations:</strong> {{ item.cancellations }}</div>
            <div><strong>Net Orders:</strong> {{ item.netOrders }}</div>
            <div><strong>Retail:</strong> {{ item.retail }}</div>
          </div>
        </div>
      </div>
      <div style="width: 100%; margin-top: 24px;">
        <div style="display: flex; justify-content: flex-end; align-items: center; padding-right: 50px;">
          <!-- <button (click)="currentPage = currentPage - 1" [disabled]="currentPage === 1"
            style="padding: 6px 12px; margin-right: 8px; border: 1px solid #ccc; background: #f5f5f5; color: #666; cursor: pointer;">
            Prev
          </button> -->
          <button (click)="currentPage = currentPage - 1" [disabled]="currentPage === 1" [ngStyle]="{
              'padding': '6px 12px',
              'margin-right': '8px',
              'border': currentPage === 1 ? '1px solid #ccc' : '1px solid #222fb9',
              'background': currentPage === 1 ? '#f5f5f5' : 'white',
              'color': currentPage === 1 ? '#666' : '#222fb9',
              'cursor': currentPage === 1 ? 'not-allowed' : 'pointer'
            }">
            Prev
          </button>


          <span style="margin: 0 8px; color: #555;">
            Page {{ currentPage }} of {{ totalPs1Pages }}
          </span>

          <!-- <button (click)="currentPage = currentPage + 1" [disabled]="currentPage === totalPs1Pages"
            style="padding: 6px 12px; margin-left: 8px; border: 1px solid #222fb9; background: white; color: #222fb9; cursor: pointer;">
            Next
          </button> -->
          <button (click)="currentPage = currentPage + 1" [disabled]="currentPage === totalPs1Pages" [ngStyle]="{
              'padding': '6px 12px',
              'margin-left': '8px',
              'border': currentPage === totalPs1Pages ? '1px solid #ccc' : '1px solid #222fb9',
              'background': currentPage === totalPs1Pages ? '#f5f5f5' : 'white',
              'color': currentPage === totalPs1Pages ? '#666' : '#222fb9',
              'cursor': currentPage === totalPs1Pages ? 'not-allowed' : 'pointer'
            }">
            Next
          </button>

        </div>
      </div>

    </ng-container>

    <!-- No PS message -->
    <ng-template #noPSData>
      <div *ngIf="!loadingPS" style="text-align: center; padding: 60px 20px; color: #666; font-style: italic;
                  background-color: #f9f9f9; border-radius: 12px; margin-top: 20px;
                  font-family: 'Poppins', sans-serif;  width: 100%;">
        <!-- <div style="font-size: 48px; color: #ccc; margin-bottom: 16px;">
          <i class="fas fa-user-slash"></i>
        </div> -->
        <!-- <div style="font-size: 18px; font-weight: 500; color: #888; margin-bottom: 8px;">
          No PS data found
        </div> -->
        <div style="font-size: 14px; color: #aaa;">
          There are no PS records available for <strong>{{ selectedSM.sm_name }}</strong>
        </div>
      </div>
    </ng-template>

  </div>
</div>

<!-- No PS data message -->




<!-- Pagination aligned to right -->

<!-- </div> -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Chart.js Script -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const ctx = document.getElementById('doughnutChart').getContext('2d');
  new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['Red', 'Blue', 'Yellow'],
      datasets: [{
        data: [300, 50, 100],
        backgroundColor: ['#ff0000', '#0000ff', '#ffff00'],
        hoverOffset: 4
      }]
    }
  });

  document.addEventListener('DOMContentLoaded', function () {
    fetch('https://uat.smartassistapp.in/api/superAdmin/superAdmin-dashboardd') // Replace with your actual API endpoint
      .then(response => response.json())
      .then(data => {
        populateTable(data.data.rankings.leads); // Assuming the structure is data.data.rankings.leads
      })
      .catch(error => {
        console.error('Error fetching data:', error);
        // Optionally display an error message in the table
      });

    function populateTable(leadsData) {
      const tableBody = document.querySelector('#dataTable tbody');
      tableBody.innerHTML = ''; // Clear any existing rows

      leadsData.forEach(dealer => {
        const row = tableBody.insertRow();
        const nameCell = row.insertCell();
        const codeCell = row.insertCell();
        const locationCell = row.insertCell();
        const phoneCell = row.insertCell();
        const countCell = row.insertCell();
        const rankCell = row.insertCell();

        nameCell.textContent = dealer.dealer_name;
        codeCell.textContent = dealer.dealer_code;
        locationCell.textContent = dealer.location;
        phoneCell.textContent = dealer.phone || dealer.mobile || ''; // Use phone if available, otherwise mobile
        countCell.textContent = dealer.value;
        rankCell.textContent = dealer.rank;
      });
    }
  });
</script>